---
layout: post
title: シャーディング方法いろいろ
tags:
- DB
---

## まとまった情報
https://www.slideshare.net/ssuser21f9f1/railsdb
Aimingのスライド。メジャーな方法がまとまってる。

### 分散方法
あるデータをどのシャードに保存するかをどうやって決めるか

* idのmodを取る
* マッピングテーブルを作る
* なんかの値をハッシュ関数にかけた結果のmod
* シャード番号を予め織り込んだidを作る

マッピングテーブル以外本質的に同じなんちゃうかという気はする
最後のやつはmodと比較するとどのシャードに保存するかをid採番するやつが選べるという点は違う。シャード先のロードバランシングとかができる

### 採番戦略
* 採番用テーブルを作る
  + 連番にするとスケールしない
* UUIDを使う

採番方法は以下のように分類できる
* だれが採番するか


## 方法一覧

全体的に古い(2012年くらい)ので注意。
シャーディング自体が枯れまくってる。

### Pinterest
https://medium.com/@Pinterest_Engineering/sharding-pinterest-how-we-scaled-our-mysql-fleet-3f341e96ca6f
特徴:
* 予め論理的に大量のシャードを作っておいて、論理シャードを別なホストに移動することでスケールアウトできる。
* (シャード番号, データの型, テーブル内の連番) の組を64ビット(正確には62ビット)整数にエンコードしてIDとして扱っている。
* ↑のID以外で引っ張りたいデータは別で管理して、 `hash(何らかのデータ) % シャード数` で振り分けする。
* 多対多関係のようなマッピングテーブルは片方のidの該当するシャードに突っ込む。この方法だと一方向にしかデータを引けなくなるので、逆引きもしたい場合はもう一個テーブルを作る。
* すべてのオブジェクトに対して一意なIDが振られるのが特徴。


### Instagram
https://instagram-engineering.com/sharding-ids-at-instagram-1cf5a71e5a5c
特徴:
* Pinterestに似た方法。
* (タイムスタンプ, シャード番号, テーブル内での連番 % 1024) の組を64ビット整数にエンコードしてIDとして扱っている。
* (AのID < BのID) <=> (BはAよりあとに作成された) が成り立つのが特徴。
* ストアドファンクションでIDの採番をしている。アプリケーション側ではシャードさえ決まれば採番ロジックを意識する必要はない。

### Flickr
http://code.flickr.net/2010/02/08/ticket-servers-distributed-unique-primary-keys-on-the-cheap/
特徴:
* このメモに載っている中では一番モンストに近い構造。
* 採番テーブルを持っている。採番テーブル内でのIDの更新は `REPLACE INTO` で行っている。
* 冗長性のため、奇数番の採番テーブルと偶数番の採番テーブルを分けている。

### クックパッド
https://techlife.cookpad.com/entry/2015/06/22/134108
* シャーディングに使われているmixed_gaugeというgemはspec含めて1500行程度と非常にコンパクト。
* なんかの値 `v` に対して `n = hash(v) mod N` を使って保存するシャードを選ぶ。 `n` の値と保存先のホストの対応関係だけ手動で持っておく。「なんかの値」が何なのかはこの記事からはわからなかった。


### Twitter
https://blog.twitter.com/engineering/en_us/a/2013/new-tweets-per-second-record-and-how.html
SnowflakeというID生成器を使って(作って)る
https://www.slideshare.net/moaikids/20130901-snowflake

* (タイムスタンプ, ID生成器のID, 生成器ごとの連番) の組を64ビット整数にエンコードしてIDとして扱っている。
* Pinterestはアプリケーションのロジックでカバー(多分)、Instagramはストアドファンクションを使ったのに対し、TwitterはID採番サーバーを立てた。
* 時間はunixtimeそのものではなく、特定の時刻(比較的最近)の時刻を0とするようにずらすことでビット数が少なくなってもある程度長い時間に対応できるようにしている。Instagramもたしかこんな感じの方法を取ってるはず。
