---
layout: post
title: Amazon Dash Buttonが届いたのでとりあえずツイートボタンにしてみた
tags:
- JavaScript

---
{% raw %}
<p>ついに我が家にも<a class="keyword" href="http://d.hatena.ne.jp/keyword/Amazon">Amazon</a> Dash Buttonが届きました。</p><p><span itemscope itemtype="http://schema.org/Photograph"><img src="/img/post/2017-01-11-https-cdn-ak.f.st-hatena.com-images-fotolife-c-cloudear8-20170111-20170111144526.jpg" alt="f:id:cloudear8:20170111144526j:plain" title="f:id:cloudear8:20170111144526j:plain" class="hatena-fotolife" itemprop="image"></span></p><p>そのまま使うのも面白くないので、npmのdash-buttonというライブラリを使ってツイートボタンにしてみたいと思います。</p><p><iframe src="//hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fide%2Fdash-button" title="ide/dash-button" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://github.com/ide/dash-button">github.com</a></cite></p><p><span style="font-size: 80%"><br />
注意: dash-buttonはES2015の新文法をバリバリ使っているので、比較的新しめのnode.jsじゃないと動きません。この記事での動作環境は6.9.4ですが、それでもasyncやimport等が未対応なため、dash-buttonのドキュメントのサンプルはそのままでは動きません。</span></p><p>まずはdash-buttonとlibpcap-devをインストールします。</p>
<pre class="code" data-lang="" data-unlink>$ mkdir dash-button-example
$ cd $_
$ npm init
$ sudo apt install libpcap-dev
$ npm install --save dash-button</pre><p>dash-buttonのドキュメントにある通り、package.<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>の"scripts"の値に"scan"を追加します。</p>
<pre class="code lang-javascript" data-lang="javascript" data-unlink><span class="synIdentifier">{</span>
  <span class="synConstant">&quot;scripts&quot;</span>: <span class="synIdentifier">{</span>
    <span class="synConstant">&quot;scan&quot;</span>: <span class="synConstant">&quot;dash-button scan&quot;</span>
  <span class="synIdentifier">}</span>
<span class="synIdentifier">}</span>
</pre><p>そして以下のコマンドを実行すると、Dash Buttonの<a class="keyword" href="http://d.hatena.ne.jp/keyword/MAC%A5%A2%A5%C9%A5%EC%A5%B9">MACアドレス</a>をスキャンすることができます。</p>
<pre class="code" data-lang="" data-unlink>$ sudo npm run scan</pre><p>上のコマンドを実行した状態で、Dash Buttonの設定を行います。<br />
メニューの「アカウントサービス」から、「Dash端末」の「新しい端末をセットアップ」を選びます。</p><p><span itemscope itemtype="http://schema.org/Photograph"><img src="/img/post/2017-01-11-https-cdn-ak.f.st-hatena.com-images-fotolife-c-cloudear8-20170111-20170111145813.png" alt="f:id:cloudear8:20170111145813p:plain" title="f:id:cloudear8:20170111145813p:plain" class="hatena-fotolife" itemprop="image"></span></p><p>後は画面の指示に従うだけです。<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a>の設定が終わり、商品選択画面になったらXボタンで閉じるなりアプリを終了するなりしましょう。もし間違えて商品を選択してしまうと、動作確認にボタンを1回押す毎に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%F3%A5%C8%A5%EA%A1%BC">サントリー</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C5%B7%C1%B3%BF%E5">天然水</a>が1ケース届いてしまい悲惨なことになります。</p><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a>の設定が終わったら、コンソールにDash Buttonの<a class="keyword" href="http://d.hatena.ne.jp/keyword/MAC%A5%A2%A5%C9%A5%EC%A5%B9">MACアドレス</a>が表示されているはずです。</p>
<pre class="code" data-lang="" data-unlink>Scanning for DHCP requests and ARP probes on wlp6s0...
Detected a DHCP request or ARP probe from **:**:**:**:**:**</pre><p>これを確認して、Ctrl+Cなどで実行を終了します。</p><p>以上で準備は完了です。とりあえず適当にコードを書いてみましょう。</p>
<pre class="code lang-javascript" data-lang="javascript" data-unlink><span class="synIdentifier">var</span> DashButton = require(<span class="synConstant">'dash-button'</span>);

<span class="synStatement">const</span> MAC_ADDR = <span class="synConstant">'先ほどのMACアドレス'</span>;

<span class="synIdentifier">var</span> button = <span class="synStatement">new</span> DashButton(MAC_ADDR);

button.addListener(() =&gt; <span class="synIdentifier">{</span>
    console.log(<span class="synConstant">'button pushed'</span>);
<span class="synIdentifier">}</span>);
</pre><p>実行</p>
<pre class="code" data-lang="" data-unlink>$ sudo node main.js
(ここでボタンを押す)
button pushed</pre><p>Dash Buttonの押下を検知できていることが確認できました。</p><p>これだけでは面白くないので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/twitter">twitter</a>ライブラリを使ってツイートボタンにしてみました。</p>
<pre class="code" data-lang="" data-unlink>$ npm install --save twitter</pre><pre class="code lang-javascript" data-lang="javascript" data-unlink><span class="synIdentifier">var</span> DashButton = require(<span class="synConstant">'dash-button'</span>);
<span class="synIdentifier">var</span> Twitter = require(<span class="synConstant">'twitter'</span>);

<span class="synStatement">const</span> MAC_ADDR = <span class="synConstant">'(MACアドレス)'</span>;

<span class="synIdentifier">var</span> button = <span class="synStatement">new</span> DashButton(MAC_ADDR);
<span class="synIdentifier">var</span> client = <span class="synStatement">new</span> Twitter(<span class="synIdentifier">{</span>
    consumer_key: <span class="synConstant">'CONSUMER KEY'</span>,
    consumer_secret: <span class="synConstant">'CONSUMER SECRET'</span>,
    access_token_key: <span class="synConstant">'ACCESS TOKEN'</span>,
    access_token_secret: <span class="synConstant">'ACCESS TOKEN SECRET'</span>
<span class="synIdentifier">}</span>);

button.addListener(() =&gt; <span class="synIdentifier">{</span>
    <span class="synStatement">const</span> date = <span class="synStatement">new</span> <span class="synType">Date</span>();
    client.post(<span class="synConstant">'statuses/update'</span>,
                <span class="synIdentifier">{</span> <span class="synStatement">status</span>: `Dash Buttonが押されました。時刻: $<span class="synIdentifier">{</span>date<span class="synIdentifier">}</span>` <span class="synIdentifier">}</span>,
                (err, tweet, resp) =&gt; <span class="synIdentifier">{</span>
                    <span class="synStatement">if</span> (err) <span class="synIdentifier">{</span>
                        console.log(err);
                    <span class="synIdentifier">}</span> <span class="synStatement">else</span> <span class="synIdentifier">{</span>
                        console.log(<span class="synConstant">'tweeted'</span>);
                    <span class="synIdentifier">}</span>
                <span class="synIdentifier">}</span>);
<span class="synIdentifier">}</span>);
</pre><p>これを実行した状態でDash Buttonを押すと、実際にツイートできているのが確認できます。</p><p><span itemscope itemtype="http://schema.org/Photograph"><img src="/img/post/2017-01-11-https-cdn-ak.f.st-hatena.com-images-fotolife-c-cloudear8-20170111-20170111165442.png" alt="f:id:cloudear8:20170111165442p:plain" title="f:id:cloudear8:20170111165442p:plain" class="hatena-fotolife" itemprop="image"></span></p>


{% endraw %}
