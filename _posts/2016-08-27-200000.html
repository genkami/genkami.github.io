---
layout: post
title: Gaucheでモナド その2
tags:
- Gauche

---
{% raw %}
<p><iframe src="http://inkar-us-i.hatenablog.com/embed/2016/07/04/184329" title="Scheme始めました - きくらげ観察日記" class="embed-card embed-blogcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="/2016/07/04/184329.html">inkar-us-i.hatenablog.com</a></cite></p><p>このときは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>歴半日くらいだったんで中置<-<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B1%E9%BB%BB%BB%D2">演算子</a>とか定義してて微妙な感じの構文だったので、もう少し<a class="keyword" href="http://d.hatena.ne.jp/keyword/Lisp">Lisp</a>らしい<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%CA%A5%C9">モナド</a>を書いてみました。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synConstant">*monad-stack*</span> <span class="synSpecial">'())</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>push-monad! monad<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synConstant">*monad-stack*</span> <span class="synSpecial">(</span><span class="synIdentifier">cons</span> monad <span class="synConstant">*monad-stack*</span><span class="synSpecial">)))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>pop-monad!<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synConstant">*monad-stack*</span> <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> <span class="synConstant">*monad-stack*</span><span class="synSpecial">)))</span>

<span class="synSpecial">(</span>define-class <span class="synConstant">&lt;monad&gt;</span> <span class="synSpecial">()</span>
  <span class="synSpecial">((</span>return :init-keyword :return :getter monad-return<span class="synSpecial">)</span>
   <span class="synSpecial">(</span>bind :init-keyword :bind :getter monad-bind<span class="synSpecial">)))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>mbind mexpr cont<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>monad <span class="synSpecial">(</span><span class="synIdentifier">car</span> <span class="synConstant">*monad-stack*</span><span class="synSpecial">)))</span>
    <span class="synSpecial">((</span>monad-bind monad<span class="synSpecial">)</span> mexpr cont<span class="synSpecial">)))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>mreturn expr<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>monad <span class="synSpecial">(</span><span class="synIdentifier">car</span> <span class="synConstant">*monad-stack*</span><span class="synSpecial">)))</span>
    <span class="synSpecial">((</span>monad-return monad<span class="synSpecial">)</span> expr<span class="synSpecial">)))</span>

<span class="synSpecial">(</span><span class="synStatement">define-syntax</span> mlet*-body
  <span class="synSpecial">(</span><span class="synStatement">syntax-rules</span> <span class="synSpecial">()</span>
    <span class="synSpecial">((</span>_ <span class="synSpecial">()</span> body<span class="synSpecial">)</span> body<span class="synSpecial">)</span>
    <span class="synSpecial">((</span>_ <span class="synSpecial">()</span> body body2 rest ...<span class="synSpecial">)</span>
     <span class="synSpecial">(</span>mbind body <span class="synSpecial">(</span>^<span class="synSpecial">(</span>_<span class="synSpecial">)</span> <span class="synSpecial">(</span>mlet*-body <span class="synSpecial">()</span> body2 rest ...<span class="synSpecial">))))</span>
    <span class="synSpecial">((</span>_ <span class="synSpecial">((</span>name mexpr<span class="synSpecial">)</span> binds ...<span class="synSpecial">)</span> body ...<span class="synSpecial">)</span>
     <span class="synSpecial">(</span>mbind mexpr <span class="synSpecial">(</span>^<span class="synSpecial">(</span>name<span class="synSpecial">)</span> <span class="synSpecial">(</span>mlet*-body <span class="synSpecial">(</span>binds ...<span class="synSpecial">)</span> body ...<span class="synSpecial">))))))</span>

<span class="synSpecial">(</span><span class="synStatement">define-syntax</span> mlet*
  <span class="synSpecial">(</span><span class="synStatement">syntax-rules</span> <span class="synSpecial">()</span>
    <span class="synSpecial">((</span>_ monad binds body ...<span class="synSpecial">)</span>
     <span class="synSpecial">(</span><span class="synIdentifier">dynamic-wind</span>
         <span class="synSpecial">(</span>^<span class="synSpecial">()</span> <span class="synSpecial">(</span>push-monad! monad<span class="synSpecial">))</span>
         <span class="synSpecial">(</span>^<span class="synSpecial">()</span> <span class="synSpecial">(</span>mlet*-body binds body ...<span class="synSpecial">))</span>
         <span class="synSpecial">(</span>^<span class="synSpecial">()</span> <span class="synSpecial">(</span>pop-monad!<span class="synSpecial">))))))</span>
</pre><p>do記法というか、F#のコンピュテーション式に近いかもしれないです(F#全然知らないけど)。</p><p>あとはmlet*の中でdynamic-windしてるので、例えばState<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%CA%A5%C9">モナド</a>の中身で継続呼んでMaybe<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%CA%A5%C9">モナド</a>の中に突っ込む、みたいな状況になったとしてもバグらないようになっています。</p><p>使用例:</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synComment">;; リストモナド</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> list-monad
  <span class="synSpecial">(</span>make <span class="synConstant">&lt;monad&gt;</span>
    :return <span class="synIdentifier">list</span>
    :bind <span class="synSpecial">(</span>^<span class="synSpecial">(</span>xs f<span class="synSpecial">)</span> <span class="synSpecial">(</span>concatenate <span class="synSpecial">(</span><span class="synIdentifier">map</span> f xs<span class="synSpecial">)))))</span>

<span class="synComment">;; Maybeモナド(というかand-letモナド)</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> maybe-monad
  <span class="synSpecial">(</span>make <span class="synConstant">&lt;monad&gt;</span>
    :return identity
    :bind <span class="synSpecial">(</span>^<span class="synSpecial">(</span>mvalue f<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">eq?</span> mvalue <span class="synConstant">#f</span><span class="synSpecial">)</span> <span class="synConstant">#f</span> <span class="synSpecial">(</span>f mvalue<span class="synSpecial">)))))</span>

<span class="synSpecial">(</span>mlet*
 list-monad
 <span class="synSpecial">((</span>x <span class="synSpecial">'(</span><span class="synConstant">1</span> <span class="synConstant">2</span> <span class="synConstant">3</span> <span class="synConstant">4</span> <span class="synConstant">5</span><span class="synSpecial">))</span>
  <span class="synSpecial">(</span>y <span class="synSpecial">'(</span><span class="synConstant">2</span> <span class="synConstant">4</span> <span class="synConstant">6</span> <span class="synConstant">8</span> <span class="synConstant">9</span><span class="synSpecial">)))</span>
 <span class="synSpecial">(</span>mreturn <span class="synSpecial">(</span><span class="synIdentifier">cons</span> x y<span class="synSpecial">)))</span>
<span class="synComment">;; =&gt;</span>
<span class="synComment">;; ((1 . 2) (1 . 4) (1 . 6) (1 . 8) (1 . 9)</span>
<span class="synComment">;;  (2 . 2) (2 . 4) (2 . 6) (2 . 8) (2 . 9)</span>
<span class="synComment">;;  (3 . 2) (3 . 4) (3 . 6) (3 . 8) (3 . 9)</span>
<span class="synComment">;;  (4 . 2) (4 . 4) (4 . 6) (4 . 8) (4 . 9)</span>
<span class="synComment">;;  (5 . 2) (5 . 4) (5 . 6) (5 . 8) (5 . 9))</span>

<span class="synSpecial">(</span>mlet*
 maybe-monad
 <span class="synSpecial">((</span>x <span class="synConstant">1</span><span class="synSpecial">)</span>
  <span class="synSpecial">(</span>y <span class="synConstant">2</span><span class="synSpecial">))</span>
 <span class="synSpecial">(</span>mreturn <span class="synSpecial">(</span><span class="synIdentifier">+</span> x y<span class="synSpecial">)))</span>
<span class="synComment">;; =&gt; 3</span>

<span class="synSpecial">(</span>mlet*
 maybe-monad
 <span class="synSpecial">((</span>x <span class="synConstant">#f</span><span class="synSpecial">)</span>
  <span class="synSpecial">(</span>y <span class="synConstant">2</span><span class="synSpecial">))</span>
 <span class="synSpecial">(</span>mreturn <span class="synSpecial">(</span><span class="synIdentifier">+</span> x y<span class="synSpecial">)))</span>
<span class="synComment">;; =&gt; #f</span>
</pre><p>ちなみにこれは(mlet* ...)全体が評価されるタイミングでmreturnが呼ばれる必要があるので、state<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%CA%A5%C9">モナド</a>とかは作れません。</p>


{% endraw %}
