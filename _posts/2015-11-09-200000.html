---
layout: post
title: Bing Search APIで遊ぶ
tags:
- Python
- API

---
{% raw %}
<p>諸事情で検索機能が必要になったので、検索系の<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>の中で一番手軽に扱えそうな(とは言ってもそれほど差はありませんが)Bing Search <a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>を使ってみました。</p>

<div class="section">
    <h3><a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>キーの取得</h3>
    <p>まずは以下のサイトにアクセスします。<br />
<a href="http://datamarket.azure.com/dataset/bing/search">http://datamarket.azure.com/dataset/bing/search</a><br />
5000<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>/月までなり無料で利用できるので、適当に登録を済ませて「マイアカウント」→アカウント情報からプライマリアカウントキーを取得します。</p>

</div>
<div class="section">
    <h3>実行してみる</h3>
    <p><a href="https://datamarket.azure.com/dataset/bing/search">https://datamarket.azure.com/dataset/bing/search</a><br />
基本的に、ここから「このデータを参照」をクリックして飛べる<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%AF%A5%B9%A5%D7%A5%ED%A1%BC%A5%E9">エクスプローラ</a>ーで適当に試してみて、いい感じのパラメータを適当に与えてやれば動きます。<br />
とは言っても、それだけでは説明不足なので主なパラメータの一覧を挙げておきます:</p>

<table>
    <tr>
    <th>名前</th>
    <th>値</th>
    </tr>
    <tr>
    <td>Query</td>
    <td>検索文字列</td>
    </tr>
    <tr>
    <td>Market</td>
    <td>検索対象の言語(例: ja-JP)</td>
    </tr>
    <tr>
    <td>Adult</td>
    <td>アダルトコンテンツを表示するか(Off, Moderate, Strict)</td>
    </tr>
    <tr>
    <td>$top</td>
    <td>表示件数(最大50)</td>
    </tr>
    <tr>
    <td>$skip</td>
    <td>何件飛ばすか</td>
    </tr>
    <tr>
    <td>$format</td>
    <td>結果の形式(<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>, <a class="keyword" href="http://d.hatena.ne.jp/keyword/xml">xml</a>)</td>
    </tr>
</table><p>基本的にこのあたりのパラメータを設定しておけば大丈夫ですが、いくつか注意点があります。</p><p><b>・名前の頭に$がつかず、値が文字列である場合、値をダブルクオートで囲わなければならない</b><br />
すなわち、Queryが「<a class="keyword" href="http://d.hatena.ne.jp/keyword/hoge">hoge</a>」で$formatが「<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>」、$topが「50」の場合、</p>

<pre>Query='<a class="keyword" href="http://d.hatena.ne.jp/keyword/hoge">hoge</a>'&$format=<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>&$top=50
</pre><p>としなければなりません。</p><p><b>・名前の頭についている"$"はURL<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%F3%A5%B3%A1%BC%A5%C9">エンコード</a>してはいけない</b><br />
これがなかなかのハマり所です。通常、上のような値をGETパラメータに<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%F3%A5%B3%A1%BC%A5%C9">エンコード</a>する場合、</p>

<pre>Query=%27hoge%27&%24format=<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>&%24top=50
</pre><p>となるような実装になっていることが多いですが、この場合では「$format」と「$top」が指定されていないことになりBad Requestとなってしまいます。正しいパラメータの書き方は以下のようになります。</p>

<pre>Query=%27hoge%27&$format=<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>&$top=50
</pre><p><b>・認証方法</b><br />
認証方法は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Basic%C7%A7%BE%DA">Basic認証</a>ですが、ユーザー名とパスワードは共に先程入手したプライマリアカウントキーとなります。</p>

</div>
<div class="section">
    <h3>実行例</h3>
    <pre class="code lang-python" data-lang="python" data-unlink><span class="synComment"># -*- coding: utf-8 -*-</span>

<span class="synPreProc">import</span> requests
<span class="synPreProc">import</span> urllib.parse

<span class="synStatement">class</span> <span class="synIdentifier">BingAPI</span>(<span class="synIdentifier">object</span>):
    API_URL_BASE = <span class="synConstant">'https://api.datamarket.azure.com/Bing/Search/v1/'</span>
    <span class="synStatement">def</span> <span class="synIdentifier">__init__</span>(self, key):
        self._key = key

    <span class="synStatement">def</span> <span class="synIdentifier">search</span>(self, query, source=<span class="synConstant">'Web'</span>, top=<span class="synConstant">50</span>, skip=<span class="synConstant">0</span>):
        params = {
            <span class="synConstant">'Query'</span>: urllib.parse.quote(<span class="synConstant">&quot;'%s'&quot;</span> % query),
            <span class="synConstant">'Market'</span>: urllib.parse.quote(<span class="synConstant">&quot;'ja-JP'&quot;</span>),
            <span class="synConstant">'$top'</span>: top,
            <span class="synConstant">'$skip'</span>: skip,
            <span class="synConstant">'$format'</span>: <span class="synConstant">'json'</span>
        }
        url = self.API_URL_BASE + source + <span class="synConstant">'?'</span> + <span class="synSpecial">\</span>
              <span class="synConstant">'&amp;'</span>.join([key + <span class="synConstant">'='</span> + <span class="synIdentifier">str</span>(params[key]) <span class="synStatement">for</span> key <span class="synStatement">in</span> params.keys()])
        auth = (self._key, self._key)
        res = requests.get(url, auth=auth)
        <span class="synStatement">return</span> res.json()

<span class="synStatement">def</span> <span class="synIdentifier">main</span>():
    key = <span class="synConstant">'Primary Account Key'</span>
    api = BingAPI(key)
    json = api.search(<span class="synConstant">'たけのこの里'</span>)
    <span class="synStatement">for</span> result <span class="synStatement">in</span> json[<span class="synConstant">'d'</span>][<span class="synConstant">'results'</span>]:
        <span class="synIdentifier">print</span>(<span class="synConstant">'{Title}</span><span class="synSpecial">\t</span><span class="synConstant">{Url}'</span>.<span class="synIdentifier">format</span>(**result))

<span class="synStatement">if</span> __name__ == <span class="synConstant">'__main__'</span>:
    main()
</pre><p>実行結果:</p>

<pre>$ <a class="keyword" href="http://d.hatena.ne.jp/keyword/python">python</a> bing.py
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A4%AD%A4%CE%A4%B3%A4%CE%BB%B3">きのこの山</a>・<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A4%BF%A4%B1%A4%CE%A4%B3%A4%CE%CE%A4">たけのこの里</a>｜株式会社 明治	<a href="http://www.meiji.co.jp/sweets/chocolate/kinotake/">http://www.meiji.co.jp/sweets/chocolate/kinotake/</a>
「<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A4%AD%A4%CE%A4%B3%A4%CE%BB%B3">きのこの山</a>」と「<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A4%BF%A4%B1%A4%CE%A4%B3%A4%CE%CE%A4">たけのこの里</a>」の対決 <a class="keyword" href="http://d.hatena.ne.jp/keyword/Amazon">Amazon</a>の企画で決着 ...	<a href="http://news.livedoor.com/article/detail/10802155/">http://news.livedoor.com/article/detail/10802155/</a>
40周年 <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A4%AD%A4%CE%A4%B3%A4%CE%BB%B3">きのこの山</a>｜株式会社 明治	<a href="http://www.meiji.co.jp/sweets/chocolate/kinotake/40th/">http://www.meiji.co.jp/sweets/chocolate/kinotake/40th/</a>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A4%BF%A4%B1%A4%CE%A4%B3%A4%CE%CE%A4">たけのこの里</a> - <a class="keyword" href="http://d.hatena.ne.jp/keyword/%C0%C4%BF%B9%B8%A9">青森県</a>総合情報サイト	<a href="http://www.a-bbn.jp/ikarigaseki/takenoko.html">http://www.a-bbn.jp/ikarigaseki/takenoko.html</a>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Amazon.co.jp">Amazon.co.jp</a>: 明治 <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A4%BF%A4%B1%A4%CE%A4%B3%A4%CE%CE%A4">たけのこの里</a> 77g×10個: 食品・飲料・お酒 通販	<a href="http://www.amazon.co.jp/%E6%98%8E%E6%B2%BB-%E3%81%9F%E3%81%91%E3%81%AE%E3%81%93%E3%81%AE%E9%87%8C-77g%C3%9710%E5%80%8B/dp/B001HZ4Z8A">http://www.amazon.co.jp/%E6%98%8E%E6%B2%BB-%E3%81%9F%E3%81%91%E3%81%AE%E3%81%93%E3%81%AE%E9%87%8C-77g%C3%9710%E5%80%8B/dp/B001HZ4Z8A</a>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C6%BB%A4%CE%B1%D8%A4%A4%A4%AB%A4%EA%A4%AC%A4%BB%A4%AD">道の駅いかりがせき</a>（<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C4%F6%A5%F6%B4%D8">碇ヶ関</a>） 関の庄	<a href="http://ikarigaseki.com/takenoko">http://ikarigaseki.com/takenoko</a>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A4%BF%A4%B1%A4%CE%A4%B3%A4%CE%CE%A4">たけのこの里</a> - <a class="keyword" href="http://d.hatena.ne.jp/keyword/Wikipedia">Wikipedia</a>	<a href="https://ja.wikipedia.org/wiki/%E3%81%9F%E3%81%91%E3%81%AE%E3%81%93%E3%81%AE%E9%87%8C">https://ja.wikipedia.org/wiki/%E3%81%9F%E3%81%91%E3%81%AE%E3%81%93%E3%81%AE%E9%87%8C</a>
</pre>
</div>

{% endraw %}
