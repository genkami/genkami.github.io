---
layout: post
title: CPS変換についての覚え書き
tags:
- Gauche

---
{% raw %}
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/CPS">CPS</a>(継続渡しスタイル)とは、関数自体に「その後の処理」を引数として渡してしまうような書き方です。</p><p>例:</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synComment">;; 点(x . y)のノルムを求める</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>norm x y<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synIdentifier">sqrt</span> <span class="synSpecial">(</span><span class="synIdentifier">+</span> <span class="synSpecial">(</span><span class="synIdentifier">expt</span> x <span class="synConstant">2</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">expt</span> y <span class="synConstant">2</span><span class="synSpecial">))))</span>

<span class="synSpecial">(</span>norm <span class="synConstant">1</span> <span class="synConstant">1</span><span class="synSpecial">)</span> <span class="synComment">; =&gt; 1.414...</span>

<span class="synComment">;; normのcps版</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>norm/cps x y cont<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>expt/cps x <span class="synConstant">2</span> <span class="synSpecial">(</span>^<span class="synSpecial">(</span>x^2<span class="synSpecial">)</span>
    <span class="synSpecial">(</span>expt/cps y <span class="synConstant">2</span> <span class="synSpecial">(</span>^<span class="synSpecial">(</span>y^2<span class="synSpecial">)</span>
      <span class="synSpecial">(</span><span class="synError">+/cps</span> x^2 y^2 <span class="synSpecial">(</span>^<span class="synSpecial">(</span>norm^2<span class="synSpecial">)</span>
        <span class="synSpecial">(</span>sqrt/cps norm^2 cont<span class="synSpecial">))))))))</span>

<span class="synSpecial">(</span>norm/cps <span class="synConstant">1</span> <span class="synConstant">1</span> <span class="synSpecial">(</span>^<span class="synSpecial">(</span>n<span class="synSpecial">)</span> <span class="synComment">; =&gt; 1.414...</span>
  ...<span class="synSpecial">))</span>
</pre><p>実際はsqrt/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cps">cps</a>やらも定義してやらなければなりませんが、とりあえずイメージということで。</p><br />
<br />
<p>これって機械的に変換できるものなのでしょうか？<br />
例えば<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>中に現れるすべてのdefineとlambdaに対して</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>hoge x y z<span class="synSpecial">)</span> e1 e2 ... en<span class="synSpecial">)</span>
<span class="synComment">;; ↓CPS変換</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>hoge/cps x y z cont<span class="synSpecial">)</span> <span class="synSpecial">(</span>e1/cps <span class="synSpecial">(</span>^<span class="synSpecial">(</span>_<span class="synSpecial">)</span> <span class="synSpecial">(</span>e2/cps <span class="synSpecial">(</span>^<span class="synSpecial">(</span>_<span class="synSpecial">)</span> ... <span class="synSpecial">(</span>en/cps cont<span class="synSpecial">))))))</span>

<span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>x y<span class="synSpecial">)</span> e1 e2 ... en<span class="synSpecial">)</span>
<span class="synComment">;; ↓CPS変換</span>
<span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>x y cont<span class="synSpecial">)</span> <span class="synSpecial">(</span>e1/cps <span class="synSpecial">(</span>^<span class="synSpecial">(</span>_<span class="synSpecial">)</span> <span class="synSpecial">(</span>e2/cps <span class="synSpecial">(</span>^<span class="synSpecial">(</span>_<span class="synSpecial">)</span> ... <span class="synSpecial">(</span>en/cps cont<span class="synSpecial">))))))</span>
</pre><p>のように変換していけばいいのでしょうか？<br />
(lambda (x . args) ...)みたいな関数が出てきたときのためにcontは引数の頭にしておいたほうがいいとかいう話はおいておくとして。</p><br />
<br />
<p>こうして変換していく過程を見ていると、ほとんど<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%CA%A5%C9">モナド</a>のdo記法から>>=を使った記法への変換と同じであることが分かりますね。</p>


{% endraw %}
