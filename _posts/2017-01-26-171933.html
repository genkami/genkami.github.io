---
layout: post
title: ムシャクシャしたのでテトリスを作った
tags:
- Elm
- Products

---
{% raw %}
<p>試験の出来が悪かったので、ムシャクシャして2時間くらいキーボードを叩いていたら<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C6%A5%C8%A5%EA%A5%B9">テトリス</a>ができていました。</p><p>完成品は以下のURLに上げています。</p><p><a href="http://monamonamonad.github.io/tetris/">http://monamonamonad.github.io/tetris/</a></p><p>Elmはこれくらいの小規模なアプリケーションを書くのに便利ですね。<br />
<s><br />
追記: よくよく考えたら横一列そろったブロック消すの忘れてた。<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C6%A5%C8%A5%EA%A5%B9">テトリス</a>下手だから気づかなかった</s><br />
さらに追記: ↑さすがに直しました。</p><p>以下<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>。<br />
適当に書きなぐったやつなので&lt;table&gt;タグでレイアウトしてたりコード汚かったりしますが直すつもりはありません。</p>
<pre class="code lang-haskell" data-lang="haskell" data-unlink><span class="synType">module</span> Main exposing (<span class="synStatement">..</span>)

<span class="synPreProc">import</span> Html exposing (..)
<span class="synPreProc">import</span> Html.Events exposing (..)
<span class="synPreProc">import</span> Html.Attributes exposing (..)

<span class="synPreProc">import</span> Array exposing (Array)
<span class="synPreProc">import</span> Random
<span class="synPreProc">import</span> Time
<span class="synPreProc">import</span> Json.Decode
<span class="synPreProc">import</span> Keyboard exposing (KeyCode)


<span class="synComment">-- テトリスの操作に関するAPI</span>
<span class="synType">type</span> Color
    <span class="synStatement">=</span> Red
    <span class="synStatement">|</span> Blue
    <span class="synStatement">|</span> Green
    <span class="synStatement">|</span> Yellow
    <span class="synStatement">|</span> Purple
    <span class="synStatement">|</span> Skyblue
    <span class="synStatement">|</span> Orange

<span class="synType">type</span> alias Point <span class="synStatement">=</span>
    { x <span class="synStatement">:</span> Int
    , y <span class="synStatement">:</span> Int
    }

<span class="synType">type</span> alias Direction <span class="synStatement">=</span> Point

<span class="synType">type</span> alias Block <span class="synStatement">=</span>
    { base <span class="synStatement">:</span> Point
    , points <span class="synStatement">:</span> List Point
    , color <span class="synStatement">:</span> Color
    }

<span class="synType">type</span> alias Tetris <span class="synStatement">=</span>
    { width <span class="synStatement">:</span> Int
    , height <span class="synStatement">:</span> Int
    , movingBlock <span class="synStatement">:</span> Maybe Block
    , points <span class="synStatement">:</span> Array (Array (Maybe Color))
    , gameOver <span class="synStatement">:</span> Bool
    }

direction <span class="synStatement">=</span>
    { left <span class="synStatement">=</span> { x <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }
    , right <span class="synStatement">=</span> { x <span class="synStatement">=</span> <span class="synConstant">1</span>, y <span class="synStatement">=</span> <span class="synConstant">0</span> }
    , up <span class="synStatement">=</span> { x <span class="synStatement">=</span> <span class="synConstant">0</span>, y <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span> }
    , down <span class="synStatement">=</span> { x <span class="synStatement">=</span> <span class="synConstant">0</span>, y <span class="synStatement">=</span> <span class="synConstant">1</span> }
    }

initialTetris <span class="synStatement">:</span> Int <span class="synStatement">-&gt;</span> Int <span class="synStatement">-&gt;</span> Tetris
initialTetris width height <span class="synStatement">=</span>
    { width <span class="synStatement">=</span> width
    , height <span class="synStatement">=</span> height
    , movingBlock <span class="synStatement">=</span> Nothing
    , points <span class="synStatement">=</span> Array.repeat height (Array.repeat width Nothing)
    , gameOver <span class="synStatement">=</span> False
    }

<span class="synComment">-- 位置 (x, y) のブロックの色を取得</span>
<span class="synComment">-- Nothing -&gt; 範囲外</span>
<span class="synComment">-- Just Nothing -&gt; 範囲内だけどブロックが無い</span>
<span class="synComment">-- Just (Just c) -&gt; 色 c のブロックがある</span>
colorAt <span class="synStatement">:</span> Int <span class="synStatement">-&gt;</span> Int <span class="synStatement">-&gt;</span> Tetris <span class="synStatement">-&gt;</span> Maybe (Maybe Color)
colorAt x y tetris <span class="synStatement">=</span>
    Array.get y tetris<span class="synStatement">.</span>points
        <span class="synStatement">|&gt;</span> Maybe.andThen (Array.get x)

<span class="synComment">-- topY &lt;= y を満たすエリアを実際に使える</span>
<span class="synComment">-- それより上 (y 座標が小さいエリア) は初期ブロック出現場所</span>
topY <span class="synStatement">:</span> Int
topY <span class="synStatement">=</span> <span class="synConstant">2</span>

<span class="synComment">-- topY より上にブロックが来てたらアウト</span>
isGameOver <span class="synStatement">:</span> Tetris <span class="synStatement">-&gt;</span> Bool
isGameOver tetris <span class="synStatement">=</span>
    <span class="synStatement">let</span> colors <span class="synStatement">=</span> List.concat
                 <span class="synStatement">&lt;|</span> List.map (<span class="synStatement">\</span>y <span class="synStatement">-&gt;</span> List.map (<span class="synStatement">\</span>x <span class="synStatement">-&gt;</span> colorAt x y tetris)
                                  <span class="synStatement">&lt;|</span> List.range <span class="synConstant">0</span> (tetris<span class="synStatement">.</span>width <span class="synStatement">-</span> <span class="synConstant">1</span>))
                 <span class="synStatement">&lt;|</span> List.range <span class="synConstant">0</span> (topY <span class="synStatement">-</span> <span class="synConstant">1</span>)
        pred color <span class="synStatement">=</span>
            <span class="synStatement">case</span> color <span class="synStatement">of</span>
                Just (Just _) <span class="synStatement">-&gt;</span> True
                _ <span class="synStatement">-&gt;</span> False
    <span class="synStatement">in</span> List.any pred colors

movePoint <span class="synStatement">:</span> Point <span class="synStatement">-&gt;</span> Direction <span class="synStatement">-&gt;</span> Point
movePoint point dir <span class="synStatement">=</span>
    { x <span class="synStatement">=</span> point<span class="synStatement">.</span>x <span class="synStatement">+</span> dir<span class="synStatement">.</span>x
    , y <span class="synStatement">=</span> point<span class="synStatement">.</span>y <span class="synStatement">+</span> dir<span class="synStatement">.</span>y
    }

toPoints <span class="synStatement">:</span> Block <span class="synStatement">-&gt;</span> List Point
toPoints b <span class="synStatement">=</span> List.map (movePoint b<span class="synStatement">.</span>base) b<span class="synStatement">.</span>points

moveBlock <span class="synStatement">:</span> Block <span class="synStatement">-&gt;</span> Direction <span class="synStatement">-&gt;</span> Block
moveBlock block dir <span class="synStatement">=</span>
    { block <span class="synStatement">|</span>
          base <span class="synStatement">=</span> { x <span class="synStatement">=</span> block<span class="synStatement">.</span>base<span class="synStatement">.</span>x <span class="synStatement">+</span> dir<span class="synStatement">.</span>x
                 , y <span class="synStatement">=</span> block<span class="synStatement">.</span>base<span class="synStatement">.</span>y <span class="synStatement">+</span> dir<span class="synStatement">.</span>y }
    }

canPointPut <span class="synStatement">:</span> Point <span class="synStatement">-&gt;</span> Tetris <span class="synStatement">-&gt;</span> Bool
canPointPut p tetris <span class="synStatement">=</span>
    <span class="synStatement">case</span> colorAt p<span class="synStatement">.</span>x p<span class="synStatement">.</span>y tetris <span class="synStatement">of</span>
        Nothing <span class="synStatement">-&gt;</span> False
        Just Nothing <span class="synStatement">-&gt;</span> True
        Just (Just c) <span class="synStatement">-&gt;</span> False

canBlockPut <span class="synStatement">:</span> Block <span class="synStatement">-&gt;</span> Tetris <span class="synStatement">-&gt;</span> Bool
canBlockPut block tetris <span class="synStatement">=</span> List.all (<span class="synStatement">\</span>p <span class="synStatement">-&gt;</span> canPointPut p tetris) <span class="synStatement">&lt;|</span> toPoints block

doesBlockHavePoint <span class="synStatement">:</span> Block <span class="synStatement">-&gt;</span> Point <span class="synStatement">-&gt;</span> Bool
doesBlockHavePoint block point <span class="synStatement">=</span>
    List.member point <span class="synStatement">&lt;|</span> toPoints block

<span class="synComment">-- ブロックの回転、反転用</span>

<span class="synComment">-- 行列 a = (a11 a12)</span>
<span class="synComment">--          (a21 a22)</span>
<span class="synComment">-- を表す</span>
<span class="synType">type</span> alias Mat <span class="synStatement">=</span>
    { a11 <span class="synStatement">:</span> Int, a12 <span class="synStatement">:</span> Int
    , a21 <span class="synStatement">:</span> Int, a22 <span class="synStatement">:</span> Int
    }

apply <span class="synStatement">:</span> Mat <span class="synStatement">-&gt;</span> Point <span class="synStatement">-&gt;</span> Point
apply mat point <span class="synStatement">=</span>
    { x <span class="synStatement">=</span> mat<span class="synStatement">.</span>a11 <span class="synStatement">*</span> point<span class="synStatement">.</span>x <span class="synStatement">+</span> mat<span class="synStatement">.</span>a12 <span class="synStatement">*</span> point<span class="synStatement">.</span>y
    , y <span class="synStatement">=</span> mat<span class="synStatement">.</span>a21 <span class="synStatement">*</span> point<span class="synStatement">.</span>x <span class="synStatement">+</span> mat<span class="synStatement">.</span>a22 <span class="synStatement">*</span> point<span class="synStatement">.</span>y
    }

applyToBlock <span class="synStatement">:</span> Mat <span class="synStatement">-&gt;</span> Block <span class="synStatement">-&gt;</span> Block
applyToBlock mat block <span class="synStatement">=</span>
    { block <span class="synStatement">|</span> points <span class="synStatement">=</span> List.map (apply mat) block<span class="synStatement">.</span>points }

rotate <span class="synStatement">:</span> Mat
rotate <span class="synStatement">=</span>
    { a11 <span class="synStatement">=</span> <span class="synConstant">0</span>,  a12 <span class="synStatement">=</span> <span class="synConstant">1</span>
    , a21 <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span>, a22 <span class="synStatement">=</span> <span class="synConstant">0</span> }

<span class="synComment">-- ゲーム内で使用するブロック</span>
<span class="synComment">-- ブロックの形</span>
blocks <span class="synStatement">:</span> List Block
blocks <span class="synStatement">=</span>
    <span class="synStatement">let</span> base <span class="synStatement">=</span> { x <span class="synStatement">=</span> <span class="synConstant">0</span>, y <span class="synStatement">=</span> <span class="synConstant">0</span> } <span class="synComment">-- ダミー</span>
    <span class="synStatement">in</span>  [{ base <span class="synStatement">=</span> base <span class="synComment">-- I</span>
         , color <span class="synStatement">=</span> Purple
         , points <span class="synStatement">=</span> [ { x <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span>, y <span class="synStatement">=</span> <span class="synConstant">0</span> }
                    , { x <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">0</span>, y <span class="synStatement">=</span> <span class="synConstant">0</span> }
                    , { x <span class="synStatement">=</span>  <span class="synConstant">1</span>, y <span class="synStatement">=</span> <span class="synConstant">0</span> }
                    , { x <span class="synStatement">=</span>  <span class="synConstant">2</span>, y <span class="synStatement">=</span> <span class="synConstant">0</span> }
                    ]
         }
        , { base <span class="synStatement">=</span> base <span class="synComment">-- Z</span>
          , color <span class="synStatement">=</span> Red
          , points <span class="synStatement">=</span> [ { x <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span>, y <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span> }
                     , { x <span class="synStatement">=</span>  <span class="synConstant">0</span>, y <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span> }
                     , { x <span class="synStatement">=</span>  <span class="synConstant">0</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }
                     , { x <span class="synStatement">=</span>  <span class="synConstant">1</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }]
          }
        , { base <span class="synStatement">=</span> base <span class="synComment">-- S</span>
          , color <span class="synStatement">=</span> Skyblue
          , points <span class="synStatement">=</span> [ { x <span class="synStatement">=</span>  <span class="synConstant">1</span>, y <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span> }
                     , { x <span class="synStatement">=</span>  <span class="synConstant">0</span>, y <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span> }
                     , { x <span class="synStatement">=</span>  <span class="synConstant">0</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }
                     , { x <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }]
          }
        , { base <span class="synStatement">=</span> base <span class="synComment">-- T</span>
          , color <span class="synStatement">=</span> Green
          , points <span class="synStatement">=</span> [ { x <span class="synStatement">=</span>  <span class="synConstant">0</span>, y <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span> }
                     , { x <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }
                     , { x <span class="synStatement">=</span>  <span class="synConstant">0</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }
                     , { x <span class="synStatement">=</span>  <span class="synConstant">1</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }]
          }
        , { base <span class="synStatement">=</span> base <span class="synComment">-- J</span>
          , color <span class="synStatement">=</span> Yellow
          , points <span class="synStatement">=</span> [ { x <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span>, y <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span> }
                     , { x <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }
                     , { x <span class="synStatement">=</span>  <span class="synConstant">0</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }
                     , { x <span class="synStatement">=</span>  <span class="synConstant">1</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }]
          }
        , { base <span class="synStatement">=</span> base <span class="synComment">-- L</span>
          , color <span class="synStatement">=</span> Orange
          , points <span class="synStatement">=</span> [ { x <span class="synStatement">=</span>  <span class="synConstant">1</span>, y <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span> }
                     , { x <span class="synStatement">=</span>  <span class="synConstant">1</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }
                     , { x <span class="synStatement">=</span>  <span class="synConstant">0</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }
                     , { x <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }]
          }
        , { base <span class="synStatement">=</span> base <span class="synComment">-- O</span>
          , color <span class="synStatement">=</span> Blue
          , points <span class="synStatement">=</span> [ { x <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span>, y <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span> }
                     , { x <span class="synStatement">=</span>  <span class="synConstant">0</span>, y <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span> }
                     , { x <span class="synStatement">=</span> <span class="synStatement">-</span><span class="synConstant">1</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }
                     , { x <span class="synStatement">=</span>  <span class="synConstant">0</span>, y <span class="synStatement">=</span>  <span class="synConstant">0</span> }]
          }
        ]

<span class="synComment">-- 次のブロックをランダムに生成する</span>
generateBlock <span class="synStatement">:</span> Tetris <span class="synStatement">-&gt;</span> Random.Generator Block
generateBlock tetris <span class="synStatement">=</span>
    <span class="synStatement">let</span> base <span class="synStatement">=</span> { x <span class="synStatement">=</span> tetris<span class="synStatement">.</span>width <span class="synStatement">//</span> <span class="synConstant">2</span>
               , y <span class="synStatement">=</span> <span class="synConstant">1</span>
               }
    <span class="synStatement">in</span> randomChoose blocks
        <span class="synStatement">|&gt;</span> Random.map (<span class="synStatement">\</span>b <span class="synStatement">-&gt;</span> { b <span class="synStatement">|</span> base <span class="synStatement">=</span> base })

randomChoose <span class="synStatement">:</span> List a <span class="synStatement">-&gt;</span> Random.Generator a
randomChoose xs <span class="synStatement">=</span>
    <span class="synStatement">let</span> len <span class="synStatement">=</span> List.length xs
        get i <span class="synStatement">=</span> xs <span class="synStatement">|&gt;</span> List.drop i <span class="synStatement">|&gt;</span> List.head <span class="synStatement">|&gt;</span> fromJust
    <span class="synStatement">in</span> Random.int <span class="synConstant">0</span> (len <span class="synStatement">-</span> <span class="synConstant">1</span>)
        <span class="synStatement">|&gt;</span> Random.map get

<span class="synComment">-- ゲーム本体のロジック</span>

<span class="synComment">-- キーコード</span>
keys <span class="synStatement">=</span>
    { left <span class="synStatement">=</span> <span class="synConstant">37</span>
    , up <span class="synStatement">=</span> <span class="synConstant">38</span>
    , right <span class="synStatement">=</span> <span class="synConstant">39</span>
    , down <span class="synStatement">=</span> <span class="synConstant">40</span>
    , space <span class="synStatement">=</span> <span class="synConstant">32</span>
    }

putBlock <span class="synStatement">:</span> Tetris <span class="synStatement">-&gt;</span> Tetris
putBlock tetris <span class="synStatement">=</span>
    <span class="synStatement">case</span> tetris<span class="synStatement">.</span>movingBlock <span class="synStatement">of</span>
        Nothing <span class="synStatement">-&gt;</span> tetris
        Just block <span class="synStatement">-&gt;</span>
            <span class="synStatement">let</span> points <span class="synStatement">=</span> tetris<span class="synStatement">.</span>points
                cell x y <span class="synType">default</span> <span class="synStatement">=</span>
                    <span class="synStatement">if</span> doesBlockHavePoint block { x <span class="synStatement">=</span> x, y <span class="synStatement">=</span> y }
                    <span class="synStatement">then</span> Just block<span class="synStatement">.</span>color
                    <span class="synStatement">else</span> <span class="synType">default</span>
                newPoints <span class="synStatement">=</span> Array.indexedMap
                            (<span class="synStatement">\</span>y row <span class="synStatement">-&gt;</span> Array.indexedMap
                                 (<span class="synStatement">\</span>x d <span class="synStatement">-&gt;</span> cell x y d) row) points
                <span class="synComment">-- TODO: 以下の2つの処理はここで行うべきではない</span>
                newTetris <span class="synStatement">=</span> clearRows { tetris <span class="synStatement">|</span>
                                        points <span class="synStatement">=</span> newPoints
                                      , movingBlock <span class="synStatement">=</span> Nothing
                                      }
            <span class="synStatement">in</span> { newTetris <span class="synStatement">|</span> gameOver <span class="synStatement">=</span> isGameOver tetris }

moveBlockIfCan <span class="synStatement">:</span> Direction <span class="synStatement">-&gt;</span> Tetris <span class="synStatement">-&gt;</span> Tetris
moveBlockIfCan dir tetris <span class="synStatement">=</span>
    <span class="synStatement">case</span> tetris<span class="synStatement">.</span>movingBlock <span class="synStatement">of</span>
        Nothing <span class="synStatement">-&gt;</span> tetris
        Just block <span class="synStatement">-&gt;</span>
            <span class="synStatement">let</span> moved <span class="synStatement">=</span> moveBlock block dir
            <span class="synStatement">in</span> <span class="synStatement">if</span> canBlockPut moved tetris
               <span class="synStatement">then</span> { tetris <span class="synStatement">|</span> movingBlock <span class="synStatement">=</span> Just moved }
               <span class="synStatement">else</span> tetris

rotateMovingBlock <span class="synStatement">:</span> Tetris <span class="synStatement">-&gt;</span> Tetris
rotateMovingBlock tetris <span class="synStatement">=</span>
    <span class="synStatement">case</span> tetris<span class="synStatement">.</span>movingBlock <span class="synStatement">of</span>
        Nothing <span class="synStatement">-&gt;</span> tetris
        Just block <span class="synStatement">-&gt;</span>
            <span class="synStatement">let</span> newBlock <span class="synStatement">=</span> applyToBlock rotate block
            <span class="synStatement">in</span> <span class="synStatement">if</span> canBlockPut newBlock tetris
               <span class="synStatement">then</span> { tetris <span class="synStatement">|</span> movingBlock <span class="synStatement">=</span> Just newBlock }
               <span class="synStatement">else</span> tetris

fallOrPut <span class="synStatement">:</span> Tetris <span class="synStatement">-&gt;</span> Tetris
fallOrPut tetris <span class="synStatement">=</span>
    <span class="synStatement">case</span> tetris<span class="synStatement">.</span>movingBlock <span class="synStatement">of</span>
        Nothing <span class="synStatement">-&gt;</span> tetris
        Just block <span class="synStatement">-&gt;</span>
            <span class="synStatement">let</span> fallen <span class="synStatement">=</span> moveBlock block direction<span class="synStatement">.</span>down
            <span class="synStatement">in</span> <span class="synStatement">if</span> canBlockPut fallen tetris
               <span class="synStatement">then</span> { tetris <span class="synStatement">|</span> movingBlock <span class="synStatement">=</span> Just fallen }
               <span class="synStatement">else</span> putBlock tetris

<span class="synComment">-- ユーザーの入力</span>
userInput <span class="synStatement">:</span> KeyCode <span class="synStatement">-&gt;</span> Tetris <span class="synStatement">-&gt;</span> Tetris
userInput code tetris <span class="synStatement">=</span>
    switch
    [ (code <span class="synStatement">==</span> keys<span class="synStatement">.</span>left, moveBlockIfCan direction<span class="synStatement">.</span>left tetris)
    , (code <span class="synStatement">==</span> keys<span class="synStatement">.</span>right, moveBlockIfCan direction<span class="synStatement">.</span>right tetris)
    , (code <span class="synStatement">==</span> keys<span class="synStatement">.</span>down, moveBlockIfCan direction<span class="synStatement">.</span>down tetris)
    , (code <span class="synStatement">==</span> keys<span class="synStatement">.</span>space, rotateMovingBlock tetris)
    , (otherwise, tetris)
    ]

shouldRowClear <span class="synStatement">:</span> Array (Maybe Color) <span class="synStatement">-&gt;</span> Bool
shouldRowClear row <span class="synStatement">=</span>
    <span class="synStatement">let</span> isNotEmpty c <span class="synStatement">=</span> Maybe.map (<span class="synStatement">\</span>_ <span class="synStatement">-&gt;</span> True) c
                     <span class="synStatement">|&gt;</span> Maybe.withDefault False
    <span class="synStatement">in</span> List.all isNotEmpty <span class="synStatement">&lt;|</span> Array.toList row

remainingRows <span class="synStatement">:</span> Tetris <span class="synStatement">-&gt;</span> Array (Array (Maybe Color))
remainingRows tetris <span class="synStatement">=</span>
    Array.filter (<span class="synStatement">\</span>row <span class="synStatement">-&gt;</span> not (shouldRowClear row)) tetris<span class="synStatement">.</span>points

clearRows <span class="synStatement">:</span> Tetris <span class="synStatement">-&gt;</span> Tetris
clearRows tetris <span class="synStatement">=</span>
    <span class="synStatement">let</span> rows <span class="synStatement">=</span> remainingRows tetris
        numRows <span class="synStatement">=</span> Array.length rows
        emptyRows <span class="synStatement">=</span> Array.repeat (tetris<span class="synStatement">.</span>height <span class="synStatement">-</span> numRows)
                    <span class="synStatement">&lt;|</span> Array.repeat tetris<span class="synStatement">.</span>width Nothing
        newPoints <span class="synStatement">=</span> Array.append emptyRows rows
    <span class="synStatement">in</span> { tetris <span class="synStatement">|</span> points <span class="synStatement">=</span> newPoints }

<span class="synComment">-- モデル</span>
<span class="synType">type</span> alias Model <span class="synStatement">=</span> Tetris

<span class="synType">type</span> Msg
    <span class="synStatement">=</span> KeyPress Int
    <span class="synStatement">|</span> Fall
    <span class="synStatement">|</span> NewBlock Block

initialModel <span class="synStatement">:</span> Model
initialModel <span class="synStatement">=</span> initialTetris <span class="synConstant">10</span> <span class="synConstant">22</span>

init <span class="synStatement">:</span> (Model, Cmd Msg)
init <span class="synStatement">=</span> ( initialModel
       , Random.generate NewBlock (generateBlock initialModel)
       )

update <span class="synStatement">:</span> Msg <span class="synStatement">-&gt;</span> Model <span class="synStatement">-&gt;</span> (Model, Cmd Msg)
update msg model <span class="synStatement">=</span>
    <span class="synStatement">case</span> msg <span class="synStatement">of</span>
        NewBlock block <span class="synStatement">-&gt;</span>
            <span class="synStatement">if</span> model<span class="synStatement">.</span>gameOver
            <span class="synStatement">then</span> (model, Cmd.none)
            <span class="synStatement">else</span> ( { model <span class="synStatement">|</span> movingBlock <span class="synStatement">=</span> Just block }
                 , Cmd.none)
        KeyPress code <span class="synStatement">-&gt;</span>
            ( userInput code model
            , Cmd.none)
        Fall <span class="synStatement">-&gt;</span> nextTurn model

nextTurn <span class="synStatement">:</span> Tetris <span class="synStatement">-&gt;</span> (Tetris, Cmd Msg)
nextTurn tetris <span class="synStatement">=</span>
    <span class="synStatement">case</span> tetris<span class="synStatement">.</span>movingBlock <span class="synStatement">of</span>
        Nothing <span class="synStatement">-&gt;</span> (tetris, Random.generate NewBlock (generateBlock initialModel))
        Just _ <span class="synStatement">-&gt;</span> (fallOrPut tetris, Cmd.none)

subscriptions <span class="synStatement">:</span> Model <span class="synStatement">-&gt;</span> Sub Msg
subscriptions model <span class="synStatement">=</span>
    <span class="synStatement">if</span> model<span class="synStatement">.</span>gameOver
    <span class="synStatement">then</span> Sub.none
    <span class="synStatement">else</span> Sub.batch
        [ Time.every (Time.second) (<span class="synStatement">\</span>_ <span class="synStatement">-&gt;</span> Fall)
        , Keyboard.downs KeyPress
        ]

view <span class="synStatement">:</span> Model <span class="synStatement">-&gt;</span> Html Msg
view model <span class="synStatement">=</span>
    div []
        [ tetrisView model
        , buttons
        , message model
        ]

buttons <span class="synStatement">:</span> Html Msg
buttons <span class="synStatement">=</span>
    div []
        [ button [ style buttonStyle, onClick (KeyPress keys<span class="synStatement">.</span>left) ]
              [ text <span class="synConstant">&quot;&lt;-&quot;</span> ]
        , button [ style buttonStyle, onClick ( KeyPress keys<span class="synStatement">.</span>space) ]
              [ text <span class="synConstant">&quot;O&quot;</span> ]
        , button [ style buttonStyle, onClick (KeyPress keys<span class="synStatement">.</span>right) ]
              [ text <span class="synConstant">&quot;-&gt;&quot;</span> ]
        ]

buttonStyle <span class="synStatement">:</span> List (String, String)
buttonStyle <span class="synStatement">=</span>
    [ (<span class="synConstant">&quot;width&quot;</span>, <span class="synConstant">&quot;80px&quot;</span>)
    ]

message <span class="synStatement">:</span> Model <span class="synStatement">-&gt;</span> Html Msg
message model <span class="synStatement">=</span>
    div [ style messageStyle ]
        [ <span class="synStatement">if</span> model<span class="synStatement">.</span>gameOver
          <span class="synStatement">then</span> text <span class="synConstant">&quot;Game Over&quot;</span>
          <span class="synStatement">else</span> text <span class="synConstant">&quot;&quot;</span>
        ]

messageStyle <span class="synStatement">:</span> List (String, String)
messageStyle <span class="synStatement">=</span>
    [ (<span class="synConstant">&quot;font-size&quot;</span>, <span class="synConstant">&quot;x-large&quot;</span>)
    , (<span class="synConstant">&quot;font-weight&quot;</span>, <span class="synConstant">&quot;bold&quot;</span>)
    , (<span class="synConstant">&quot;color&quot;</span>, <span class="synConstant">&quot;red&quot;</span>)
    ]

tetrisView <span class="synStatement">:</span> Tetris <span class="synStatement">-&gt;</span> Html Msg
tetrisView tetris <span class="synStatement">=</span>
    table [] <span class="synStatement">&lt;|</span> List.map (<span class="synStatement">\</span>y <span class="synStatement">-&gt;</span> tetrisRowView y tetris)
        <span class="synStatement">&lt;|</span> List.range <span class="synConstant">0</span> (tetris<span class="synStatement">.</span>height <span class="synStatement">-</span> <span class="synConstant">1</span>)

tetrisRowView <span class="synStatement">:</span> Int <span class="synStatement">-&gt;</span> Tetris <span class="synStatement">-&gt;</span> Html Msg
tetrisRowView y tetris  <span class="synStatement">=</span>
    tr [] <span class="synStatement">&lt;|</span> List.map (<span class="synStatement">\</span>x <span class="synStatement">-&gt;</span> tetrisCellView x y tetris)
        <span class="synStatement">&lt;|</span> List.range <span class="synConstant">0</span> (tetris<span class="synStatement">.</span>width <span class="synStatement">-</span> <span class="synConstant">1</span>)

tetrisCellView <span class="synStatement">:</span> Int <span class="synStatement">-&gt;</span> Int <span class="synStatement">-&gt;</span> Tetris <span class="synStatement">-&gt;</span> Html Msg
tetrisCellView x y tetris <span class="synStatement">=</span>
    td [ style (cellStyle x y tetris) ] []

cellStyle <span class="synStatement">:</span> Int <span class="synStatement">-&gt;</span> Int <span class="synStatement">-&gt;</span> Tetris <span class="synStatement">-&gt;</span> List (String, String)
cellStyle x y tetris <span class="synStatement">=</span>
    [ (<span class="synConstant">&quot;background-color&quot;</span>, cellColor x y tetris)
    , (<span class="synConstant">&quot;width&quot;</span>, <span class="synConstant">&quot;20px&quot;</span>)
    , (<span class="synConstant">&quot;height&quot;</span>, <span class="synConstant">&quot;20px&quot;</span>)
    , (<span class="synConstant">&quot;border-radius&quot;</span>, <span class="synConstant">&quot;2px&quot;</span>)
    ]

cellColor <span class="synStatement">:</span> Int <span class="synStatement">-&gt;</span> Int <span class="synStatement">-&gt;</span> Tetris <span class="synStatement">-&gt;</span> String
cellColor x y tetris <span class="synStatement">=</span>
    <span class="synStatement">let</span> point <span class="synStatement">=</span> colorAt x y tetris
        defaultColor <span class="synStatement">=</span>
            <span class="synStatement">case</span> point <span class="synStatement">of</span>
                Just (Just c) <span class="synStatement">-&gt;</span> colorToString c
                _ <span class="synStatement">-&gt;</span> <span class="synConstant">&quot;burlywood&quot;</span>
    <span class="synStatement">in</span> <span class="synStatement">case</span> tetris<span class="synStatement">.</span>movingBlock <span class="synStatement">of</span>
           Just b <span class="synStatement">-&gt;</span> <span class="synStatement">if</span> doesBlockHavePoint b { x <span class="synStatement">=</span> x, y <span class="synStatement">=</span> y }
                     <span class="synStatement">then</span> colorToString b<span class="synStatement">.</span>color
                     <span class="synStatement">else</span> defaultColor
           Nothing <span class="synStatement">-&gt;</span> defaultColor

colorToString <span class="synStatement">:</span> Color <span class="synStatement">-&gt;</span> String
colorToString c <span class="synStatement">=</span>
    <span class="synStatement">case</span> c <span class="synStatement">of</span>
        Red <span class="synStatement">-&gt;</span> <span class="synConstant">&quot;red&quot;</span>
        Blue <span class="synStatement">-&gt;</span> <span class="synConstant">&quot;blue&quot;</span>
        Green <span class="synStatement">-&gt;</span> <span class="synConstant">&quot;green&quot;</span>
        Yellow <span class="synStatement">-&gt;</span> <span class="synConstant">&quot;yellow&quot;</span>
        Purple <span class="synStatement">-&gt;</span> <span class="synConstant">&quot;purple&quot;</span>
        Skyblue <span class="synStatement">-&gt;</span> <span class="synConstant">&quot;deepskyblue&quot;</span>
        Orange <span class="synStatement">-&gt;</span> <span class="synConstant">&quot;orangered&quot;</span>

main <span class="synStatement">=</span>
    Html.program
        { init <span class="synStatement">=</span> init
        , view <span class="synStatement">=</span> view
        , update <span class="synStatement">=</span> update
        , subscriptions <span class="synStatement">=</span> subscriptions
        }

<span class="synComment">-- その他</span>
fromJust <span class="synStatement">:</span> Maybe a <span class="synStatement">-&gt;</span> a
fromJust a <span class="synStatement">=</span> <span class="synStatement">case</span> a <span class="synStatement">of</span>
                 Just x <span class="synStatement">-&gt;</span> x
                 Nothing <span class="synStatement">-&gt;</span> Debug.crash <span class="synConstant">&quot;Nothing&quot;</span>

<span class="synComment">-- lisp でいう cond みたいなやつ</span>
switch <span class="synStatement">:</span> List (Bool, a) <span class="synStatement">-&gt;</span> a
switch xs <span class="synStatement">=</span>
    <span class="synStatement">case</span> xs <span class="synStatement">of</span>
        [] <span class="synStatement">-&gt;</span> Debug.crash <span class="synConstant">&quot;switch: no option&quot;</span>
        (cond, val) <span class="synStatement">::</span> xs <span class="synStatement">-&gt;</span> <span class="synStatement">if</span> cond <span class="synStatement">then</span> val
                             <span class="synStatement">else</span> switch xs

otherwise <span class="synStatement">:</span> Bool
otherwise <span class="synStatement">=</span> True
</pre><p>標準ライブラリの他に elm-lang/keyboard も使っています。</p>


{% endraw %}
