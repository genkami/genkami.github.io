---
layout: post
title: Gaucheで優先度付きキュー
tags:
- Gauche

---
{% raw %}
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>の練習。</p><p>実は何気に優先度付きキューの実装は初めてだったので、ツリーを配列で管理したほうが楽ということを知らずに若干手こずりました。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span>define-class <span class="synConstant">&lt;priority-queue&gt;</span> <span class="synSpecial">()</span>
  <span class="synSpecial">((</span>queue-vector :init-keyword :queue-vector :accessor queue-vector<span class="synSpecial">)</span>
   <span class="synSpecial">(</span>size :init-keyword :size :accessor size<span class="synSpecial">)</span>
   <span class="synSpecial">(</span>item&lt;? :init-keyword :item&lt;? :getter get-&lt;?<span class="synSpecial">)))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>parent-index index<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">floor</span> <span class="synSpecial">(</span><span class="synIdentifier">/</span> index <span class="synConstant">2</span><span class="synSpecial">)))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>left-index index<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">*</span> index <span class="synConstant">2</span><span class="synSpecial">))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>right-index index<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">+</span> <span class="synSpecial">(</span><span class="synIdentifier">*</span> index <span class="synConstant">2</span><span class="synSpecial">)</span> <span class="synConstant">1</span><span class="synSpecial">))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> root-index <span class="synConstant">1</span><span class="synSpecial">)</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>make-priority-queue :key <span class="synSpecial">(</span>max-size <span class="synConstant">20</span><span class="synSpecial">)</span> <span class="synSpecial">(</span>item&lt;? <span class="synIdentifier">&lt;</span><span class="synSpecial">))</span>
  <span class="synSpecial">(</span>make <span class="synConstant">&lt;priority-queue&gt;</span>
    :queue-vector <span class="synSpecial">(</span><span class="synIdentifier">make-vector</span> max-size<span class="synSpecial">)</span>
    :size <span class="synConstant">0</span>
    :item&lt;? item&lt;?<span class="synSpecial">))</span>

<span class="synComment">;;; queueに要素を追加する。</span>
<span class="synComment">;;; また、内部で確保しているvectorのサイズが足りなくなった場合は、確保し直す。</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>pq-add-to-last! queue item<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> vec <span class="synSpecial">(</span>queue-vector queue<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> len <span class="synSpecial">(</span><span class="synIdentifier">vector-length</span> vec<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">&lt;=</span> len <span class="synSpecial">(</span><span class="synIdentifier">+</span> <span class="synSpecial">(</span>size queue<span class="synSpecial">)</span> <span class="synConstant">1</span><span class="synSpecial">))</span>
      <span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synSpecial">(</span>queue-vector queue<span class="synSpecial">)</span> <span class="synSpecial">(</span>vector-copy vec <span class="synConstant">0</span> <span class="synSpecial">(</span><span class="synIdentifier">*</span> <span class="synConstant">2</span> len<span class="synSpecial">))))</span>
  <span class="synSpecial">(</span>inc! <span class="synSpecial">(</span>size queue<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synSpecial">(</span>ref <span class="synSpecial">(</span>queue-vector queue<span class="synSpecial">)</span> <span class="synSpecial">(</span>size queue<span class="synSpecial">))</span> item<span class="synSpecial">))</span> <span class="synComment">; 1オリジン(0番目は使ってない)</span>

<span class="synComment">;;; vecのn番目とm番目の要素を入れ替える</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>vector-swap! vec n m<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> item-n <span class="synSpecial">(</span>ref vec n<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> item-m <span class="synSpecial">(</span>ref vec m<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synSpecial">(</span>ref vec n<span class="synSpecial">)</span> item-m<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synSpecial">(</span>ref vec m<span class="synSpecial">)</span> item-n<span class="synSpecial">))</span>

<span class="synComment">;;; index番目の要素がその親より大きかった場合入れ替え、親に対して同様の処理を実行</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>up-heap queue index<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">&lt;=</span> index <span class="synConstant">1</span><span class="synSpecial">)</span>
      <span class="synSpecial">(</span>undefined<span class="synSpecial">)</span> <span class="synComment">; ルート要素にたどり着いた</span>
      <span class="synSpecial">(</span><span class="synStatement">let*</span> <span class="synSpecial">((</span>pindex <span class="synSpecial">(</span>parent-index index<span class="synSpecial">))</span>
             <span class="synSpecial">(</span>item <span class="synSpecial">(</span>ref <span class="synSpecial">(</span>queue-vector queue<span class="synSpecial">)</span> index<span class="synSpecial">))</span>
             <span class="synSpecial">(</span>pitem <span class="synSpecial">(</span>ref <span class="synSpecial">(</span>queue-vector queue<span class="synSpecial">)</span> pindex<span class="synSpecial">)))</span>
        <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">((</span>get-&lt;? queue<span class="synSpecial">)</span> pitem item<span class="synSpecial">)</span>
            <span class="synSpecial">(</span><span class="synStatement">begin</span>
              <span class="synSpecial">(</span>vector-swap! <span class="synSpecial">(</span>queue-vector queue<span class="synSpecial">)</span> index pindex<span class="synSpecial">)</span>
              <span class="synSpecial">(</span>up-heap queue pindex<span class="synSpecial">))))))</span>

<span class="synComment">;;; index番目の要素がその子より小さかった場合入れ替え、子に対して同様の処理を実行</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>down-heap queue index<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> vec <span class="synSpecial">(</span>queue-vector queue<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> lindex <span class="synSpecial">(</span>left-index index<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> rindex <span class="synSpecial">(</span>right-index index<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> len <span class="synSpecial">(</span>size queue<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> item&lt;? <span class="synSpecial">(</span>get-&lt;? queue<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">cond</span>
   <span class="synSpecial">((</span><span class="synIdentifier">&lt;</span> len lindex<span class="synSpecial">)</span> <span class="synComment">; 葉にたどり着いた</span>
    <span class="synSpecial">(</span>undefined<span class="synSpecial">))</span>
   <span class="synSpecial">((</span><span class="synIdentifier">&lt;</span> len rindex<span class="synSpecial">)</span> <span class="synComment">; 左にしか要素がない</span>
    <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>item&lt;? <span class="synSpecial">(</span>ref vec index<span class="synSpecial">)</span> <span class="synSpecial">(</span>ref vec lindex<span class="synSpecial">))</span>
        <span class="synSpecial">(</span>vector-swap! vec lindex index<span class="synSpecial">)))</span>
   <span class="synSpecial">((</span>item&lt;? <span class="synSpecial">(</span>ref vec lindex<span class="synSpecial">)</span> <span class="synSpecial">(</span>ref vec rindex<span class="synSpecial">))</span>
    <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>item&lt;? <span class="synSpecial">(</span>ref vec index<span class="synSpecial">)</span> <span class="synSpecial">(</span>ref vec rindex<span class="synSpecial">))</span> <span class="synComment">; 右のほうが要素が大きい</span>
        <span class="synSpecial">(</span><span class="synStatement">begin</span>
          <span class="synSpecial">(</span>vector-swap! vec rindex index<span class="synSpecial">)</span>
          <span class="synSpecial">(</span>down-heap queue rindex<span class="synSpecial">))))</span>
   <span class="synSpecial">(</span><span class="synStatement">else</span>
    <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>item&lt;? <span class="synSpecial">(</span>ref vec index<span class="synSpecial">)</span> <span class="synSpecial">(</span>ref vec lindex<span class="synSpecial">))</span> <span class="synComment">; 左の要素 &gt;= 右の要素</span>
        <span class="synSpecial">(</span><span class="synStatement">begin</span>
          <span class="synSpecial">(</span>vector-swap! vec lindex index<span class="synSpecial">)</span>
          <span class="synSpecial">(</span>down-heap queue lindex<span class="synSpecial">))))))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>pq-empty? queue<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synIdentifier">&lt;=</span> <span class="synSpecial">(</span>size queue<span class="synSpecial">)</span> <span class="synConstant">0</span><span class="synSpecial">))</span>

<span class="synComment">;;; queueに要素を挿入する</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>pq-insert-item! queue item<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>pq-add-to-last! queue item<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>up-heap queue <span class="synSpecial">(</span>size queue<span class="synSpecial">)))</span>

<span class="synComment">;;; queueから要素を取り出す</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>pq-dequeue-item! queue<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">&lt;=</span> <span class="synSpecial">(</span>size queue<span class="synSpecial">)</span> <span class="synConstant">0</span><span class="synSpecial">)</span>
      <span class="synSpecial">(</span>error <span class="synConstant">&quot;empty queue&quot;</span><span class="synSpecial">)</span>
      <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>root <span class="synSpecial">(</span>ref <span class="synSpecial">(</span>queue-vector queue<span class="synSpecial">)</span> root-index<span class="synSpecial">))</span>
            <span class="synSpecial">(</span>last <span class="synSpecial">(</span>ref <span class="synSpecial">(</span>queue-vector queue<span class="synSpecial">)</span> <span class="synSpecial">(</span>size queue<span class="synSpecial">))))</span>
        <span class="synSpecial">(</span>dec! <span class="synSpecial">(</span>size queue<span class="synSpecial">))</span>
        <span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synSpecial">(</span>ref <span class="synSpecial">(</span>queue-vector queue<span class="synSpecial">)</span> root-index<span class="synSpecial">)</span> last<span class="synSpecial">)</span>
        <span class="synSpecial">(</span>down-heap queue root-index<span class="synSpecial">)</span>
        root<span class="synSpecial">)))</span>
</pre><p>キューの作成時にitem&lt;?を指定することによって、どういった順で取り出すのかを指定できるようになっています。</p><p>実行例:</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>show-example items :optional <span class="synSpecial">(</span>item&lt;? <span class="synIdentifier">&lt;</span><span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> queue
    <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>queue <span class="synSpecial">(</span>make-priority-queue :item&lt;? item&lt;?<span class="synSpecial">)))</span>
      <span class="synSpecial">(</span><span class="synIdentifier">map</span> <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>item<span class="synSpecial">)</span>
             <span class="synSpecial">(</span>pq-insert-item! queue item<span class="synSpecial">))</span>
           items<span class="synSpecial">)</span>
      queue<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> after
    <span class="synSpecial">(</span><span class="synIdentifier">reverse</span>
     <span class="synSpecial">(</span><span class="synStatement">let</span> loop <span class="synSpecial">((</span>results <span class="synSpecial">'()))</span>
       <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>pq-empty? queue<span class="synSpecial">)</span>
           results
           <span class="synSpecial">(</span>loop <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">(</span>pq-dequeue-item! queue<span class="synSpecial">)</span> results<span class="synSpecial">))))))</span>
  <span class="synSpecial">(</span>format <span class="synConstant">#t</span> <span class="synConstant">&quot;before: ~s\n&quot;</span> items<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>format <span class="synConstant">#t</span> <span class="synConstant">&quot;after:  ~s\n&quot;</span> after<span class="synSpecial">))</span>


<span class="synSpecial">(</span>show-example <span class="synSpecial">'(</span><span class="synConstant">1</span> <span class="synConstant">4</span> <span class="synConstant">2</span> <span class="synConstant">5</span> <span class="synConstant">3</span><span class="synSpecial">))</span>
<span class="synComment">;; before: (1 4 2 5 3)</span>
<span class="synComment">;; after:  (5 4 3 2 1)</span>

<span class="synSpecial">(</span>show-example <span class="synSpecial">'(</span><span class="synConstant">1</span> <span class="synConstant">4</span> <span class="synConstant">2</span> <span class="synConstant">5</span> <span class="synConstant">3</span><span class="synSpecial">)</span> <span class="synIdentifier">&gt;</span><span class="synSpecial">)</span>
<span class="synComment">;; before: (1 4 2 5 3)</span>
<span class="synComment">;; after:  (1 2 3 4 5)</span>

<span class="synSpecial">(</span>show-example <span class="synSpecial">'(</span><span class="synConstant">&quot;hoge&quot;</span> <span class="synConstant">&quot;fuga&quot;</span> <span class="synConstant">&quot;foo&quot;</span><span class="synSpecial">)</span> <span class="synIdentifier">string&gt;?</span><span class="synSpecial">)</span>
<span class="synComment">;; before: (&quot;hoge&quot; &quot;fuga&quot; &quot;foo&quot;)</span>
<span class="synComment">;; after:  (&quot;foo&quot; &quot;fuga&quot; &quot;hoge&quot;)</span>

<span class="synSpecial">(</span>show-example <span class="synSpecial">'(</span><span class="synConstant">&quot;banana&quot;</span> <span class="synConstant">&quot;apple&quot;</span> <span class="synConstant">&quot;strawberry&quot;</span><span class="synSpecial">)</span> <span class="synIdentifier">string&gt;?</span><span class="synSpecial">)</span>
<span class="synComment">;; before: (&quot;banana&quot; &quot;apple&quot; &quot;strawberry&quot;)</span>
<span class="synComment">;; after:  (&quot;apple&quot; &quot;banana&quot; &quot;strawberry&quot;)</span>

<span class="synSpecial">(</span>show-example <span class="synSpecial">'(</span><span class="synConstant">&quot;banana&quot;</span> <span class="synConstant">&quot;apple&quot;</span> <span class="synConstant">&quot;strawberry&quot;</span><span class="synSpecial">)</span>
              <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>x y<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">&lt;</span> <span class="synSpecial">(</span><span class="synIdentifier">string-length</span> x<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">string-length</span> y<span class="synSpecial">))))</span>
<span class="synComment">;; before: (&quot;banana&quot; &quot;apple&quot; &quot;strawberry&quot;)</span>
<span class="synComment">;; after:  (&quot;strawberry&quot; &quot;banana&quot; &quot;apple&quot;)</span>
</pre><p>実行時間の計測もしてみました</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span>use data.random<span class="synSpecial">)</span>
<span class="synSpecial">(</span>use gauche.time<span class="synSpecial">)</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> generate-random <span class="synSpecial">(</span>integers$ <span class="synConstant">100000000</span><span class="synSpecial">))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>bench n<span class="synSpecial">)</span>
  <span class="synComment">;; +10してるのは特に意味はない(+1以上ならok)</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> queue <span class="synSpecial">(</span>make-priority-queue :max-size <span class="synSpecial">(</span><span class="synIdentifier">+</span> n <span class="synConstant">10</span><span class="synSpecial">)))</span>
  <span class="synSpecial">(</span>dolist <span class="synSpecial">(</span>i <span class="synSpecial">(</span>iota n<span class="synSpecial">))</span>
    <span class="synSpecial">(</span>pq-insert-item! queue <span class="synSpecial">(</span>generate-random<span class="synSpecial">)))</span>
  <span class="synSpecial">(</span>dolist <span class="synSpecial">(</span>i <span class="synSpecial">(</span>iota n<span class="synSpecial">))</span>
    <span class="synSpecial">(</span>pq-dequeue-item! queue<span class="synSpecial">)))</span>

<span class="synSpecial">(</span>time-this <span class="synConstant">1</span> <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">()</span> <span class="synSpecial">(</span>bench <span class="synConstant">100</span><span class="synSpecial">)))</span>
<span class="synComment">;; #&lt;time-result 1 times/  0.003 real/  0.000 user/  0.000 sys&gt;</span>

<span class="synSpecial">(</span>time-this <span class="synConstant">1</span> <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">()</span> <span class="synSpecial">(</span>bench <span class="synConstant">1000</span><span class="synSpecial">)))</span>
<span class="synComment">;; #&lt;time-result 1 times/  0.039 real/  0.040 user/  0.000 sys&gt;</span>

<span class="synSpecial">(</span>time-this <span class="synConstant">1</span> <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">()</span> <span class="synSpecial">(</span>bench <span class="synConstant">10000</span><span class="synSpecial">)))</span>
<span class="synComment">;; #&lt;time-result 1 times/  0.520 real/  0.520 user/  0.000 sys&gt;</span>

<span class="synSpecial">(</span>time-this <span class="synConstant">1</span> <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">()</span> <span class="synSpecial">(</span>bench <span class="synConstant">100000</span><span class="synSpecial">)))</span>
<span class="synComment">;; #&lt;time-result 1 times/  7.824 real/ 10.910 user/  0.000 sys&gt;</span>
</pre><p>要素の追加に平均<img src="http://chart.apis.google.com/chart?cht=tx&chl=O%281%29" alt="O(1)"/>, 先頭要素のdequeueに平均<img src="http://chart.apis.google.com/chart?cht=tx&chl=O%28logn%29" alt="O(logn)"/>かかりますので、計算時間の増え方としてはだいたい(かなり大雑把ですが)</p>

<pre>(一つ前の結果 + 定数) * 10
</pre><p>くらいになってくれるはずですので、まあこんなもんでしょう。</p><p>それにしても遅い……。</p>


{% endraw %}
