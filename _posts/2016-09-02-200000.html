---
layout: post
title: Gaucheに継続を「実装」する
tags:
- Gauche

---
{% raw %}
<p><a href="/2016/09/01/200000.html">/2016/09/01/200000.html</a><cite class="hatena-citation"><a href="/2016/09/01/200000.html">inkar-us-i.hatenablog.com</a></cite></p><p>上の記事でしっかりした<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%CA%A5%C9">モナド</a>が作れたので、これを使って継続を実装します。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>cont-return x<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>^<span class="synSpecial">(</span>cont<span class="synSpecial">)</span> <span class="synSpecial">(</span>cont x<span class="synSpecial">)))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>cont-bind x f<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>^<span class="synSpecial">(</span>cont<span class="synSpecial">)</span>
    <span class="synSpecial">(</span>x <span class="synSpecial">(</span>^<span class="synSpecial">(</span>xval<span class="synSpecial">)</span>
         <span class="synSpecial">((</span>f xval<span class="synSpecial">)</span> cont<span class="synSpecial">)))))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> cont-monad
  <span class="synSpecial">(</span>make <span class="synConstant">&lt;monad&gt;</span>
    :return cont-return
    :bind cont-bind<span class="synSpecial">))</span>
</pre><p>Cont<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%CA%A5%C9">モナド</a>は暗黙的な<a class="keyword" href="http://d.hatena.ne.jp/keyword/CPS">CPS</a>変換を行う<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%CA%A5%C9">モナド</a>です。暗黙引数?<a class="keyword" href="http://d.hatena.ne.jp/keyword/monad">monad</a>にcont-<a class="keyword" href="http://d.hatena.ne.jp/keyword/monad">monad</a>が与えられた場合、(mreturn x)は継続を引数に受け取ってその継続にxを渡す関数となります。</p><p>次に、call/ccに相当する関数を作ってみます。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>mcall/cc handler<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>^<span class="synSpecial">(</span>cont<span class="synSpecial">)</span>
    <span class="synSpecial">(</span>handler cont<span class="synSpecial">)))</span>
</pre><p>簡単ですね。Cont<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%CA%A5%C9">モナド</a>の中ではすべての式は<a class="keyword" href="http://d.hatena.ne.jp/keyword/CPS">CPS</a>変換されているので、貰った継続をそのまま渡せばOKです。</p><p>実行例は以下の通り。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synConstant">*mcont*</span> <span class="synConstant">#f</span><span class="synSpecial">)</span>
<span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>?monad cont-monad<span class="synSpecial">))</span>
  <span class="synSpecial">((</span>mlet*
    <span class="synSpecial">((</span>result
      <span class="synSpecial">(</span>mcall/cc
       <span class="synSpecial">(</span>^<span class="synSpecial">(</span>cont<span class="synSpecial">)</span>
         <span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synConstant">*mcont*</span> cont<span class="synSpecial">)</span>
         <span class="synSpecial">(</span>cont <span class="synConstant">&quot;hoge&quot;</span><span class="synSpecial">)))))</span>
    <span class="synSpecial">(</span>mreturn result<span class="synSpecial">))</span>
   identity <span class="synComment">; 最後に「トップレベルへの継続」に相当するものを渡す</span>
   <span class="synSpecial">))</span>
<span class="synComment">;; =&gt; &quot;hoge&quot;</span>

<span class="synSpecial">(</span><span class="synConstant">*mcont*</span> <span class="synConstant">&quot;fuga&quot;</span><span class="synSpecial">)</span> <span class="synComment">; 保存した継続は後から呼び出せる</span>
<span class="synComment">;; =&gt; &quot;fuga&quot;</span>
</pre><p>もちろん、(mlet* ..)の結果を保存しておいて、後で継続とともに呼び出すこともできます。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synConstant">*mcont2*</span> <span class="synConstant">#f</span><span class="synSpecial">)</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synConstant">*mcont3*</span> <span class="synConstant">#f</span><span class="synSpecial">)</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> proc <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>?monad cont-monad<span class="synSpecial">))</span>
  <span class="synSpecial">(</span>mlet*
   <span class="synSpecial">((</span>x <span class="synSpecial">(</span>mcall/cc
        <span class="synSpecial">(</span>^<span class="synSpecial">(</span>cont<span class="synSpecial">)</span>
          <span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synConstant">*mcont2*</span> cont<span class="synSpecial">)</span>
          <span class="synSpecial">(</span>cont <span class="synConstant">&quot;hoge&quot;</span><span class="synSpecial">))))</span>
    <span class="synSpecial">(</span>y <span class="synSpecial">(</span>mcall/cc
        <span class="synSpecial">(</span>^<span class="synSpecial">(</span>cont<span class="synSpecial">)</span>
          <span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synConstant">*mcont3*</span> cont<span class="synSpecial">)</span>
          <span class="synSpecial">(</span>cont <span class="synConstant">&quot;fuga&quot;</span><span class="synSpecial">)))))</span>
   <span class="synSpecial">(</span>mreturn <span class="synSpecial">(</span>format <span class="synConstant">#f</span> <span class="synConstant">&quot;~s: ~s&quot;</span> x y<span class="synSpecial">)))))</span>

<span class="synSpecial">(</span>proc print<span class="synSpecial">)</span>     <span class="synComment">; =&gt; &quot;hoge&quot;: &quot;fuga&quot;</span>
<span class="synSpecial">(</span><span class="synConstant">*mcont2*</span> <span class="synConstant">&quot;foo&quot;</span><span class="synSpecial">)</span> <span class="synComment">; =&gt; &quot;foo&quot;: &quot;fuga&quot;</span>
<span class="synSpecial">(</span><span class="synConstant">*mcont3*</span> <span class="synConstant">&quot;bar&quot;</span><span class="synSpecial">)</span> <span class="synComment">; =&gt; &quot;foo&quot;: &quot;bar&quot;</span>
</pre>

{% endraw %}
