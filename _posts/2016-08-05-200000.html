---
layout: post
title: Gaucheでパーセプトロンを作った
tags:
- Gauche

---
{% raw %}
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>の練習。<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%BB%A5%D7%A5%C8%A5%ED%A5%F3">パーセプトロン</a>は簡単に作れる割に何となく学習してくれた感があって面白いです。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synComment">;; perceptron.scm</span>
<span class="synSpecial">(</span>use gauche.collection<span class="synSpecial">)</span>

<span class="synComment">;; xがしきい値を超えているかを判定する関数</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>sig x<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">&lt;=</span> x <span class="synConstant">0</span><span class="synSpecial">)</span> <span class="synConstant">0</span> <span class="synConstant">1</span><span class="synSpecial">))</span>

<span class="synComment">;; 最終的な結果を出力するためのニューロン</span>
<span class="synSpecial">(</span>define-class <span class="synConstant">&lt;neuron&gt;</span> <span class="synSpecial">()</span>
  <span class="synSpecial">((</span>inputs :init-keyword :inputs :accessor inputs<span class="synSpecial">)</span> <span class="synComment">;; 入力のベクタ</span>
   <span class="synSpecial">(</span>weights :init-keyword :weights :accessor weights<span class="synSpecial">)))</span> <span class="synComment">;; 重みのベクタ</span>

<span class="synSpecial">(</span>define-method generate-output <span class="synSpecial">((</span>neuron <span class="synConstant">&lt;neuron&gt;</span><span class="synSpecial">))</span>
  <span class="synSpecial">(</span>sig <span class="synSpecial">(</span><span class="synIdentifier">apply</span> <span class="synIdentifier">+</span>
            <span class="synSpecial">(</span><span class="synIdentifier">map</span> <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>i w<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">*</span> <span class="synSpecial">(</span>generate-output i<span class="synSpecial">)</span> w<span class="synSpecial">))</span>
                        <span class="synSpecial">(</span>inputs neuron<span class="synSpecial">)</span>
                        <span class="synSpecial">(</span>weights neuron<span class="synSpecial">)))))</span>

<span class="synComment">;; ニューロンの重みを関数fを用いて更新する</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>update-weights-with! f neuron<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>vector-map-with-index
   <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>i input<span class="synSpecial">)</span>
     <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>out <span class="synSpecial">(</span>generate-output input<span class="synSpecial">))</span>
           <span class="synSpecial">(</span>weight <span class="synSpecial">(</span>ref <span class="synSpecial">(</span>weights neuron<span class="synSpecial">)</span> i<span class="synSpecial">)))</span>
       <span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synSpecial">(</span>ref <span class="synSpecial">(</span>weights neuron<span class="synSpecial">)</span> i<span class="synSpecial">)</span> <span class="synSpecial">(</span>f weight out<span class="synSpecial">))))</span>
   <span class="synSpecial">(</span>inputs neuron<span class="synSpecial">)))</span>

<span class="synComment">;; ニューロンの重みに入力を足し引きする</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>increase-weights! neuron<span class="synSpecial">)</span> <span class="synSpecial">(</span>update-weights-with! <span class="synIdentifier">+</span> neuron<span class="synSpecial">))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>decrease-weights! neuron<span class="synSpecial">)</span> <span class="synSpecial">(</span>update-weights-with! <span class="synIdentifier">-</span> neuron<span class="synSpecial">))</span>

<span class="synComment">;; 入力のorをとるやつ</span>
<span class="synSpecial">(</span>define-class <span class="synConstant">&lt;logical-or&gt;</span> <span class="synSpecial">()</span>
  <span class="synSpecial">((</span>inputs :init-keyword :inputs :accessor inputs<span class="synSpecial">)))</span>

<span class="synSpecial">(</span>define-method generate-output <span class="synSpecial">((</span>logical-or <span class="synConstant">&lt;logical-or&gt;</span><span class="synSpecial">))</span>
  <span class="synSpecial">(</span>fold <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>x y<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synStatement">or</span> x y<span class="synSpecial">))</span> <span class="synSpecial">(</span>inputs logical-or<span class="synSpecial">)))</span>

<span class="synComment">;; getterの返り値をそのまま返す</span>
<span class="synSpecial">(</span>define-class <span class="synConstant">&lt;constant-input&gt;</span> <span class="synSpecial">()</span>
  <span class="synSpecial">((</span>getter :init-keyword :getter :accessor getter<span class="synSpecial">)))</span>

<span class="synSpecial">(</span>define-method generate-output <span class="synSpecial">((</span>constant <span class="synConstant">&lt;constant-input&gt;</span><span class="synSpecial">))</span>
  <span class="synSpecial">((</span>getter constant<span class="synSpecial">)))</span>

<span class="synComment">;; パーセプトロンの教師データ</span>
<span class="synSpecial">(</span>define-class <span class="synConstant">&lt;supervisor&gt;</span> <span class="synSpecial">()</span>
  <span class="synSpecial">((</span>inputs :init-keyword :inputs :accessor inputs<span class="synSpecial">)</span> <span class="synComment">; 入力の値</span>
   <span class="synSpecial">(</span>expected :init-keyword :expected :accessor expected<span class="synSpecial">)))</span>

<span class="synComment">;; neuronにsupervisorsを用いて学習をさせる。</span>
<span class="synComment">;; また、入力の変化はupdate-inputsによって行う。</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>learn supervisors update-inputs neuron<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> is-all-correct? <span class="synConstant">#f</span><span class="synSpecial">)</span>
  <span class="synSpecial">(</span>while <span class="synSpecial">(</span><span class="synIdentifier">not</span> is-all-correct?<span class="synSpecial">)</span>
    <span class="synSpecial">(</span><span class="synStatement">set!</span> is-all-correct? <span class="synConstant">#t</span><span class="synSpecial">)</span>
    <span class="synSpecial">(</span><span class="synIdentifier">map</span>
     <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>supervisor<span class="synSpecial">)</span>
       <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>ins <span class="synSpecial">(</span>inputs supervisor<span class="synSpecial">))</span>
             <span class="synSpecial">(</span>e <span class="synSpecial">(</span>expected supervisor<span class="synSpecial">)))</span>
         <span class="synSpecial">(</span>update-inputs ins<span class="synSpecial">)</span>
         <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">=</span> e <span class="synSpecial">(</span>generate-output neuron<span class="synSpecial">))</span>
             <span class="synConstant">#f</span> <span class="synComment">; 出力結果が教師データと一致した場合、何もしない</span>
             <span class="synSpecial">(</span><span class="synStatement">begin</span>
               <span class="synSpecial">(</span><span class="synStatement">set!</span> is-all-correct? <span class="synConstant">#f</span><span class="synSpecial">)</span>
               <span class="synSpecial">(</span><span class="synStatement">cond</span>
                <span class="synSpecial">((</span><span class="synIdentifier">=</span> e <span class="synConstant">1</span><span class="synSpecial">)</span> <span class="synComment">; 1を0と判断</span>
                 <span class="synSpecial">(</span>increase-weights! neuron<span class="synSpecial">))</span>
                <span class="synSpecial">((</span><span class="synIdentifier">=</span> e <span class="synConstant">0</span><span class="synSpecial">)</span> <span class="synComment">; 0を1と判断</span>
                 <span class="synSpecial">(</span>decrease-weights! neuron<span class="synSpecial">)))))))</span>
     supervisors<span class="synSpecial">)))</span>
</pre><p>使用例として、この<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%BB%A5%D7%A5%C8%A5%ED%A5%F3">パーセプトロン</a>に「x1とx2のORとは何か」を学習させてみました。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synComment">;; 入力はx1, x2, x3の3つ。</span>
<span class="synComment">;; x1とx2のORを取る。</span>
<span class="synComment">;; x3はしきい値を与えるためのダミー</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> input-vector <span class="synConstant">#f</span><span class="synSpecial">)</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>update-input-vector! vec<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">set!</span> input-vector vec<span class="synSpecial">))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> x1 <span class="synSpecial">(</span>make <span class="synConstant">&lt;constant-input&gt;</span>
             :getter <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">()</span> <span class="synSpecial">(</span>ref input-vector <span class="synConstant">0</span><span class="synSpecial">))))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> x2 <span class="synSpecial">(</span>make <span class="synConstant">&lt;constant-input&gt;</span>
             :getter <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">()</span> <span class="synSpecial">(</span>ref input-vector <span class="synConstant">1</span><span class="synSpecial">))))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> x3 <span class="synSpecial">(</span>make <span class="synConstant">&lt;constant-input&gt;</span>
             :getter <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">()</span> <span class="synSpecial">(</span><span class="synIdentifier">-</span> <span class="synConstant">1</span><span class="synSpecial">))))</span>

<span class="synComment">;; パーセプトロン</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> example-perceptron
  <span class="synSpecial">(</span>make <span class="synConstant">&lt;neuron&gt;</span>
    :inputs <span class="synSpecial">(</span><span class="synIdentifier">vector</span> x1 x2 x3<span class="synSpecial">)</span>
    :weights <span class="synSpecial">#(</span><span class="synConstant">0</span> <span class="synConstant">0</span> <span class="synConstant">0</span><span class="synSpecial">)))</span>

<span class="synComment">;; x1, x2の組と、出力が取るべき値の組からなる教師データ</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> example-supervisors
  <span class="synSpecial">(</span><span class="synIdentifier">list</span>
   <span class="synSpecial">(</span>make <span class="synConstant">&lt;supervisor&gt;</span> :inputs <span class="synSpecial">#(</span><span class="synConstant">0</span> <span class="synConstant">0</span><span class="synSpecial">)</span> :expected <span class="synConstant">0</span><span class="synSpecial">)</span>
   <span class="synSpecial">(</span>make <span class="synConstant">&lt;supervisor&gt;</span> :inputs <span class="synSpecial">#(</span><span class="synConstant">0</span> <span class="synConstant">1</span><span class="synSpecial">)</span> :expected <span class="synConstant">1</span><span class="synSpecial">)</span>
   <span class="synSpecial">(</span>make <span class="synConstant">&lt;supervisor&gt;</span> :inputs <span class="synSpecial">#(</span><span class="synConstant">1</span> <span class="synConstant">0</span><span class="synSpecial">)</span> :expected <span class="synConstant">1</span><span class="synSpecial">)</span>
   <span class="synSpecial">(</span>make <span class="synConstant">&lt;supervisor&gt;</span> :inputs <span class="synSpecial">#(</span><span class="synConstant">1</span> <span class="synConstant">1</span><span class="synSpecial">)</span> :expected <span class="synConstant">1</span><span class="synSpecial">)))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>example-learn<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>learn example-supervisors update-input-vector! example-perceptron<span class="synSpecial">))</span>

<span class="synSpecial">(</span>example-learn<span class="synSpecial">)</span>

<span class="synComment">;; 学習した結果を表示</span>
<span class="synSpecial">(</span><span class="synIdentifier">map</span>
 <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>ins<span class="synSpecial">)</span>
   <span class="synSpecial">(</span><span class="synStatement">set!</span> input-vector ins<span class="synSpecial">)</span>
   <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>out <span class="synSpecial">(</span>generate-output example-perceptron<span class="synSpecial">)))</span>
     <span class="synSpecial">(</span><span class="synIdentifier">display</span> ins<span class="synSpecial">)</span>
     <span class="synSpecial">(</span><span class="synIdentifier">display</span> <span class="synConstant">&quot;: &quot;</span><span class="synSpecial">)</span>
     <span class="synSpecial">(</span><span class="synIdentifier">display</span> out<span class="synSpecial">)</span>
     <span class="synSpecial">(</span><span class="synIdentifier">newline</span><span class="synSpecial">)))</span>
 <span class="synSpecial">(</span><span class="synIdentifier">list</span> <span class="synSpecial">#(</span><span class="synConstant">0</span> <span class="synConstant">0</span><span class="synSpecial">)</span> <span class="synSpecial">#(</span><span class="synConstant">0</span> <span class="synConstant">1</span><span class="synSpecial">)</span> <span class="synSpecial">#(</span><span class="synConstant">1</span> <span class="synConstant">0</span><span class="synSpecial">)</span> <span class="synSpecial">#(</span><span class="synConstant">1</span> <span class="synConstant">1</span><span class="synSpecial">)))</span>
</pre><p>実行結果</p>

<pre>$ gosh perceptron.scm
#(0 0): 0
#(0 1): 1
#(1 0): 1
#(1 1): 1
</pre>

{% endraw %}
