---
layout: post
title: Needleman-Wunsch法により配列の大域アラインメントを求める
tags:
- Algorithm
- Gauche

---
{% raw %}
<p>アラインメントとは、2つの配列s, tに欠損記号「-」を挿入して、出来る限り2つの一致度が高くなるように並べたものです。<br />
例えば、2つの文字列"ABCD"と"ACDE"があったとき、これは1つめの文字列から'B'を削除して末尾に'E'を挿入たものだと考えるのが自然でしょう。この時の2つの文字列のアラインメントは、それぞれ"ABCD-"と"A-CDE"となります。</p><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%EB%A5%B4%A5%EA%A5%BA%A5%E0">アルゴリズム</a>自体の説明は「Needleman-Wunsch」とかでググれば出てくるので割愛します。<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>による実装がこちら。<br />
alignment関数は2つの文字列s, tとパラメータweight, gap-penaltyを受け取り、sとtの類似度の最大値と、類似度を最大値にするようなsとtのアラインメントをそれぞれ返します。なお、アラインメントはリストで表され、各要素は文字か欠損値#fで表されます。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span>use util.match<span class="synSpecial">)</span>
<span class="synSpecial">(</span>use gauche.array<span class="synSpecial">)</span>
<span class="synSpecial">(</span>use gauche.parameter<span class="synSpecial">)</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> weight
  <span class="synSpecial">(</span>make-parameter
   <span class="synSpecial">(</span>^<span class="synSpecial">(</span>x y<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">eqv?</span> x y<span class="synSpecial">)</span> <span class="synConstant">1</span> <span class="synConstant">-1</span><span class="synSpecial">))))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> gap-penalty
  <span class="synSpecial">(</span>make-parameter <span class="synConstant">1</span><span class="synSpecial">))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> arr~ array-ref<span class="synSpecial">)</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>alignment s t<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> w <span class="synSpecial">(</span>weight<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> d <span class="synSpecial">(</span>gap-penalty<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> s-len <span class="synSpecial">(</span><span class="synIdentifier">string-length</span> s<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> t-len <span class="synSpecial">(</span><span class="synIdentifier">string-length</span> t<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> s-arr <span class="synSpecial">(</span><span class="synIdentifier">apply</span> array <span class="synSpecial">(</span>shape <span class="synConstant">0</span> s-len<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">string-&gt;list</span> s<span class="synSpecial">)))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> t-arr <span class="synSpecial">(</span><span class="synIdentifier">apply</span> array <span class="synSpecial">(</span>shape <span class="synConstant">0</span> t-len<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">string-&gt;list</span> t<span class="synSpecial">)))</span>
  <span class="synSpecial">(</span><span class="synStatement">letrec</span> <span class="synSpecial">((</span>calc
            <span class="synSpecial">(</span>^<span class="synSpecial">(</span>i j<span class="synSpecial">)</span>
              <span class="synSpecial">(</span>lazy
               <span class="synSpecial">(</span>match <span class="synSpecial">(</span><span class="synIdentifier">cons</span> i j<span class="synSpecial">)</span>
                 <span class="synSpecial">((</span>_ <span class="synSpecial">.</span> <span class="synConstant">0</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">*</span> i <span class="synSpecial">(</span><span class="synIdentifier">-</span> d<span class="synSpecial">)))</span>
                 <span class="synSpecial">((</span><span class="synConstant">0</span> <span class="synSpecial">.</span> _<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">*</span> j <span class="synSpecial">(</span><span class="synIdentifier">-</span> d<span class="synSpecial">)))</span>
                 <span class="synSpecial">((</span>_ <span class="synSpecial">.</span> _<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">max</span> <span class="synSpecial">(</span><span class="synIdentifier">-</span> <span class="synSpecial">(</span><span class="synIdentifier">force</span> <span class="synSpecial">(</span>arr~ dp <span class="synSpecial">(</span><span class="synIdentifier">-</span> i <span class="synConstant">1</span><span class="synSpecial">)</span> j<span class="synSpecial">))</span> d<span class="synSpecial">)</span>
                               <span class="synSpecial">(</span><span class="synIdentifier">-</span> <span class="synSpecial">(</span><span class="synIdentifier">force</span> <span class="synSpecial">(</span>arr~ dp i <span class="synSpecial">(</span><span class="synIdentifier">-</span> j <span class="synConstant">1</span><span class="synSpecial">)))</span> d<span class="synSpecial">)</span>
                               <span class="synSpecial">(</span><span class="synIdentifier">+</span> <span class="synSpecial">(</span><span class="synIdentifier">force</span> <span class="synSpecial">(</span>arr~ dp <span class="synSpecial">(</span><span class="synIdentifier">-</span> i <span class="synConstant">1</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">-</span> j <span class="synConstant">1</span><span class="synSpecial">)))</span>
                                  <span class="synSpecial">(</span>w <span class="synSpecial">(</span>arr~ s-arr <span class="synSpecial">(</span><span class="synIdentifier">-</span> i <span class="synConstant">1</span><span class="synSpecial">))</span>
                                     <span class="synSpecial">(</span>arr~ t-arr <span class="synSpecial">(</span><span class="synIdentifier">-</span> j <span class="synConstant">1</span><span class="synSpecial">))))))</span>
                 <span class="synSpecial">))))</span>
           <span class="synSpecial">(</span>dp
            <span class="synSpecial">(</span>tabulate-array
             <span class="synSpecial">(</span>shape <span class="synConstant">0</span> <span class="synSpecial">(</span><span class="synIdentifier">+</span> s-len <span class="synConstant">1</span><span class="synSpecial">)</span> <span class="synConstant">0</span> <span class="synSpecial">(</span><span class="synIdentifier">+</span> t-len <span class="synConstant">1</span><span class="synSpecial">))</span> calc<span class="synSpecial">)))</span>
    <span class="synSpecial">(</span>receive <span class="synSpecial">(</span>s-align t-align<span class="synSpecial">)</span> <span class="synSpecial">(</span>split <span class="synSpecial">(</span>path s-arr t-arr dp<span class="synSpecial">))</span>
      <span class="synSpecial">(</span><span class="synIdentifier">values</span>
       <span class="synSpecial">(</span><span class="synIdentifier">force</span> <span class="synSpecial">(</span>arr~ dp s-len t-len<span class="synSpecial">))</span>
       s-align t-align<span class="synSpecial">)</span>
      <span class="synSpecial">)))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>path s-arr t-arr dp<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> w <span class="synSpecial">(</span>weight<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> d <span class="synSpecial">(</span>gap-penalty<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">let</span> loop <span class="synSpecial">((</span>i <span class="synSpecial">(</span>array-length s-arr <span class="synConstant">0</span><span class="synSpecial">))</span>
             <span class="synSpecial">(</span>j <span class="synSpecial">(</span>array-length t-arr <span class="synConstant">0</span><span class="synSpecial">))</span>
             <span class="synSpecial">(</span>result <span class="synSpecial">()))</span>
    <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synStatement">and</span> <span class="synSpecial">(</span><span class="synIdentifier">=</span> i <span class="synConstant">0</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">=</span> j <span class="synConstant">0</span><span class="synSpecial">))</span>
        result
        <span class="synSpecial">(</span>let1 dp-val <span class="synSpecial">(</span><span class="synIdentifier">force</span> <span class="synSpecial">(</span>arr~ dp i j<span class="synSpecial">))</span>
          <span class="synSpecial">(</span><span class="synStatement">cond</span>
           <span class="synSpecial">((</span><span class="synIdentifier">=</span> dp-val <span class="synSpecial">(</span><span class="synIdentifier">-</span> <span class="synSpecial">(</span><span class="synIdentifier">force</span> <span class="synSpecial">(</span>arr~ dp <span class="synSpecial">(</span><span class="synIdentifier">-</span> i <span class="synConstant">1</span><span class="synSpecial">)</span> j<span class="synSpecial">))</span> d<span class="synSpecial">))</span>
            <span class="synSpecial">(</span>loop <span class="synSpecial">(</span><span class="synIdentifier">-</span> i <span class="synConstant">1</span><span class="synSpecial">)</span> j
                  <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">(</span>arr~ s-arr <span class="synSpecial">(</span><span class="synIdentifier">-</span> i <span class="synConstant">1</span><span class="synSpecial">))</span> <span class="synConstant">#f</span><span class="synSpecial">)</span>
                        result<span class="synSpecial">)))</span>
           <span class="synSpecial">((</span><span class="synIdentifier">=</span> dp-val <span class="synSpecial">(</span><span class="synIdentifier">-</span> <span class="synSpecial">(</span><span class="synIdentifier">force</span> <span class="synSpecial">(</span>arr~ dp i <span class="synSpecial">(</span><span class="synIdentifier">-</span> j <span class="synConstant">1</span><span class="synSpecial">)))</span> d<span class="synSpecial">))</span>
            <span class="synSpecial">(</span>loop i <span class="synSpecial">(</span><span class="synIdentifier">-</span> j <span class="synConstant">1</span><span class="synSpecial">)</span>
                  <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synConstant">#f</span> <span class="synSpecial">(</span>arr~ t-arr <span class="synSpecial">(</span><span class="synIdentifier">-</span> j <span class="synConstant">1</span><span class="synSpecial">)))</span>
                        result<span class="synSpecial">)))</span>
           <span class="synSpecial">(</span><span class="synStatement">else</span>
            <span class="synSpecial">(</span>loop <span class="synSpecial">(</span><span class="synIdentifier">-</span> i <span class="synConstant">1</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">-</span> j <span class="synConstant">1</span><span class="synSpecial">)</span>
                  <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">(</span>arr~ s-arr <span class="synSpecial">(</span><span class="synIdentifier">-</span> i <span class="synConstant">1</span><span class="synSpecial">))</span> <span class="synSpecial">(</span>arr~ t-arr <span class="synSpecial">(</span><span class="synIdentifier">-</span> j <span class="synConstant">1</span><span class="synSpecial">)))</span>
                        result<span class="synSpecial">)))</span>
           <span class="synSpecial">)))))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>split lst<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>match lst
    <span class="synSpecial">(()</span> <span class="synSpecial">(</span><span class="synIdentifier">values</span> <span class="synSpecial">()</span> <span class="synSpecial">()))</span>
    <span class="synSpecial">(((</span>x <span class="synSpecial">.</span> y<span class="synSpecial">)</span> <span class="synSpecial">.</span> rest<span class="synSpecial">)</span> <span class="synSpecial">(</span>receive <span class="synSpecial">(</span>xs ys<span class="synSpecial">)</span> <span class="synSpecial">(</span>split rest<span class="synSpecial">)</span>
                        <span class="synSpecial">(</span><span class="synIdentifier">values</span> <span class="synSpecial">(</span><span class="synIdentifier">cons</span> x xs<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">cons</span> y ys<span class="synSpecial">))))))</span>
</pre><p>実行結果:</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink>gosh&gt; <span class="synSpecial">(</span>alignment <span class="synConstant">&quot;ABCD&quot;</span> <span class="synConstant">&quot;ACDE&quot;</span><span class="synSpecial">)</span>
<span class="synConstant">1</span>
<span class="synSpecial">(</span><span class="synConstant">#\A</span> <span class="synConstant">#\B</span> <span class="synConstant">#\C</span> <span class="synConstant">#\D</span> <span class="synConstant">#f</span><span class="synSpecial">)</span>
<span class="synSpecial">(</span><span class="synConstant">#\A</span> <span class="synConstant">#f</span> <span class="synConstant">#\C</span> <span class="synConstant">#\D</span> <span class="synConstant">#\E</span><span class="synSpecial">)</span>
</pre><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%C6%B0%C5%AA%B7%D7%B2%E8%CB%A1">動的計画法</a>は遅延評価のある言語だと漸化式を書くだけで綺麗に解ける、ということを示したかったのですが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Scheme">Scheme</a>だとそこまで綺麗になりませんでした。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Haskell">Haskell</a>だと<a class="keyword" href="http://d.hatena.ne.jp/keyword/ST%A5%E2">STモ</a>ナドを使ってdpテーブルを破壊的に更新するよりも100倍綺麗に書けます。</p><p>なお、普通の書き方をするとalignment関数は以下のようになります。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>alignment-destructive s t<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> w <span class="synSpecial">(</span>weight<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> d <span class="synSpecial">(</span>gap-penalty<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> s-len <span class="synSpecial">(</span><span class="synIdentifier">string-length</span> s<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> t-len <span class="synSpecial">(</span><span class="synIdentifier">string-length</span> t<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> s-arr <span class="synSpecial">(</span><span class="synIdentifier">apply</span> array <span class="synSpecial">(</span>shape <span class="synConstant">0</span> s-len<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">string-&gt;list</span> s<span class="synSpecial">)))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> t-arr <span class="synSpecial">(</span><span class="synIdentifier">apply</span> array <span class="synSpecial">(</span>shape <span class="synConstant">0</span> t-len<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">string-&gt;list</span> t<span class="synSpecial">)))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> dp
    <span class="synSpecial">(</span>make-array
     <span class="synSpecial">(</span>shape <span class="synConstant">0</span> <span class="synSpecial">(</span><span class="synIdentifier">+</span> s-len <span class="synConstant">1</span><span class="synSpecial">)</span> <span class="synConstant">0</span> <span class="synSpecial">(</span><span class="synIdentifier">+</span> t-len <span class="synConstant">1</span><span class="synSpecial">))</span> <span class="synConstant">#f</span><span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>calc! i j<span class="synSpecial">)</span>
    <span class="synSpecial">(</span><span class="synStatement">define</span> val <span class="synSpecial">(</span>arr~ dp i j<span class="synSpecial">))</span>
    <span class="synSpecial">(</span><span class="synStatement">or</span> val
        <span class="synSpecial">(</span>let1 x <span class="synSpecial">(</span>match <span class="synSpecial">(</span><span class="synIdentifier">cons</span> i j<span class="synSpecial">)</span>
                  <span class="synSpecial">((</span>_ <span class="synSpecial">.</span> <span class="synConstant">0</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">*</span> i <span class="synSpecial">(</span><span class="synIdentifier">-</span> d<span class="synSpecial">)))</span>
                  <span class="synSpecial">((</span><span class="synConstant">0</span> <span class="synSpecial">.</span> _<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">*</span> j <span class="synSpecial">(</span><span class="synIdentifier">-</span> d<span class="synSpecial">)))</span>
                  <span class="synSpecial">((</span>_ <span class="synSpecial">.</span> _<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">max</span> <span class="synSpecial">(</span><span class="synIdentifier">-</span> <span class="synSpecial">(</span>calc! <span class="synSpecial">(</span><span class="synIdentifier">-</span> i <span class="synConstant">1</span><span class="synSpecial">)</span> j<span class="synSpecial">)</span> d<span class="synSpecial">)</span>
                                <span class="synSpecial">(</span><span class="synIdentifier">-</span> <span class="synSpecial">(</span>calc! i <span class="synSpecial">(</span><span class="synIdentifier">-</span> j <span class="synConstant">1</span><span class="synSpecial">))</span> d<span class="synSpecial">)</span>
                                <span class="synSpecial">(</span><span class="synIdentifier">+</span> <span class="synSpecial">(</span>calc! <span class="synSpecial">(</span><span class="synIdentifier">-</span> i <span class="synConstant">1</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">-</span> j <span class="synConstant">1</span><span class="synSpecial">))</span>
                                   <span class="synSpecial">(</span>w <span class="synSpecial">(</span>arr~ s-arr <span class="synSpecial">(</span><span class="synIdentifier">-</span> i <span class="synConstant">1</span><span class="synSpecial">))</span>
                                      <span class="synSpecial">(</span>arr~ t-arr <span class="synSpecial">(</span><span class="synIdentifier">-</span> j <span class="synConstant">1</span><span class="synSpecial">))))))</span>
                  <span class="synSpecial">)</span>
          <span class="synSpecial">(</span>array-set! dp i j x<span class="synSpecial">)</span>
          x
          <span class="synSpecial">)))</span>
  <span class="synSpecial">(</span>calc! s-len t-len<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>receive <span class="synSpecial">(</span>s-align t-align<span class="synSpecial">)</span> <span class="synSpecial">(</span>split <span class="synSpecial">(</span>path s-arr t-arr dp<span class="synSpecial">))</span>
    <span class="synSpecial">(</span><span class="synIdentifier">values</span>
     <span class="synSpecial">(</span>arr~ dp s-len t-len<span class="synSpecial">)</span>
     s-align t-align<span class="synSpecial">)</span>
    <span class="synSpecial">))</span>
</pre>

{% endraw %}
