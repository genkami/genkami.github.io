---
layout: post
title: CGIの仕様
tags:
- Others
- Gauche

---
{% raw %}
<p>とある理由から<a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>とかいう謎なことをしなければならなくなったので、ここにメモしておきます。</p>

<ol>
<li>メソッドは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>REQUEST_METHODに保存される。</li>
<li>GETパラメータは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/QUERY_STRING">QUERY_STRING</a>、POSTのボディは標準入力。ただし、GET/POSTパラメータは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>では<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>-mainの引数の引数に渡される</li>
<li>GETパラメータが<a class="keyword" href="http://d.hatena.ne.jp/keyword/hoge">hoge</a>=fugaという形式ではない場合、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%DE%A5%F3%A5%C9%A5%E9%A5%A4%A5%F3">コマンドライン</a>引数にそのまま渡される</li>
<li>標準出力がヘッダ以降のレスポンスになる</li>
<li>ヘッダにStatus: x があると、レスポンスの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%C6%A1%BC%A5%BF%A5%B9%A5%B3%A1%BC%A5%C9">ステータスコード</a>がxにする。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>では(<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>-headers :status x)でできる。</li>
</ol><p>試しに以下のようなプログラムを書いてみました。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synError">#!/usr/bin/env</span> gosh
<span class="synComment">;; example.scm</span>

<span class="synSpecial">(</span>use www.cgi<span class="synSpecial">)</span>
<span class="synSpecial">(</span>use text.html-lite<span class="synSpecial">)</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>main args<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>cgi-main
   <span class="synSpecial">(</span>^<span class="synSpecial">(</span>params<span class="synSpecial">)</span>
     <span class="synSpecial">(</span><span class="synIdentifier">list</span>
      <span class="synSpecial">(</span>cgi-header :status <span class="synConstant">404</span><span class="synSpecial">)</span>
      <span class="synSpecial">(</span>html-doctype<span class="synSpecial">)</span>
      <span class="synSpecial">(</span>html:html
       <span class="synSpecial">(</span>html:head
        <span class="synSpecial">(</span>html:title <span class="synConstant">&quot;Not Found&quot;</span><span class="synSpecial">))</span>
       <span class="synSpecial">(</span>html:body
        <span class="synSpecial">(</span>html:h1 <span class="synConstant">&quot;404 Not Found&quot;</span><span class="synSpecial">)</span>
        <span class="synSpecial">(</span>html:div
         <span class="synConstant">&quot;method: &quot;</span> <span class="synSpecial">(</span>sys-getenv <span class="synConstant">&quot;REQUEST_METHOD&quot;</span><span class="synSpecial">))</span>
        <span class="synSpecial">(</span>html:div
         <span class="synConstant">&quot;params: &quot;</span> <span class="synSpecial">(</span>x-&gt;string params<span class="synSpecial">))</span>
        <span class="synSpecial">(</span>html:div
         <span class="synConstant">&quot;args: &quot;</span> <span class="synSpecial">(</span>x-&gt;string args<span class="synSpecial">))</span>
        <span class="synSpecial">))))))</span>
</pre><p>うまく行けば404が返ってきて、パラメータやらメソッドやらが表示されるはずです。</p>
<pre class="code" data-lang="" data-unlink>$ # 404が返ってくるはず
$ curl http://localhost/example.scm -o /dev/null -w &#39;%{http_code}&#39; -s
404
$ curl http://localhost/example.scm?hoge=fuga
&lt;!DOCTYPE HTML PUBLIC &#34;-//W3C//DTD HTML 4.01//EN&#34;
       &#34;http://www.w3.org/TR/html4/strict.dtd&#34;&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Not Found&lt;/title
&gt;&lt;/head
&gt;&lt;body&gt;&lt;h1&gt;404 Not Found&lt;/h1
&gt;&lt;div&gt;method: GET&lt;/div
&gt;&lt;div&gt;params: ((hoge fuga))&lt;/div
&gt;&lt;div&gt;args: (/var/www/example.scm)&lt;/div
&gt;&lt;/body
&gt;&lt;/html
&gt;
$ # コマンドライン引数にfoobarが渡される
$ curl http://localhost/example.scm?foobar
&lt;!DOCTYPE HTML PUBLIC &#34;-//W3C//DTD HTML 4.01//EN&#34;
       &#34;http://www.w3.org/TR/html4/strict.dtd&#34;&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Not Found&lt;/title
&gt;&lt;/head
&gt;&lt;body&gt;&lt;h1&gt;404 Not Found&lt;/h1
&gt;&lt;div&gt;method: GET&lt;/div
&gt;&lt;div&gt;params: ((foobar #t))&lt;/div
&gt;&lt;div&gt;args: (/var/www/example.scm foobar)&lt;/div
&gt;&lt;/body
&gt;&lt;/html
&gt;
$ curl -X POST -d bar=baz http://localhost/example.scm
&lt;!DOCTYPE HTML PUBLIC &#34;-//W3C//DTD HTML 4.01//EN&#34;
       &#34;http://www.w3.org/TR/html4/strict.dtd&#34;&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Not Found&lt;/title
&gt;&lt;/head
&gt;&lt;body&gt;&lt;h1&gt;404 Not Found&lt;/h1
&gt;&lt;div&gt;method: POST&lt;/div
&gt;&lt;div&gt;params: ((bar baz))&lt;/div
&gt;&lt;div&gt;args: (/var/www/example.scm)&lt;/div
&gt;&lt;/body
&gt;&lt;/html
&gt;
$ # POSTのときはquery stringはparamsに渡されない
$ curl -X POST -d bar=baz http://localhost/example.scm?hoge=fuga
&lt;!DOCTYPE HTML PUBLIC &#34;-//W3C//DTD HTML 4.01//EN&#34;
       &#34;http://www.w3.org/TR/html4/strict.dtd&#34;&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Not Found&lt;/title
&gt;&lt;/head
&gt;&lt;body&gt;&lt;h1&gt;404 Not Found&lt;/h1
&gt;&lt;div&gt;method: POST&lt;/div
&gt;&lt;div&gt;params: ((bar baz))&lt;/div
&gt;&lt;div&gt;args: (/var/www/example.scm)&lt;/div
&gt;&lt;/body
&gt;&lt;/html
&gt;
$ # でもコマンドライン引数には与えられる
$ curl -X POST -d bar=baz http://localhost/example.scm?hoge
&lt;!DOCTYPE HTML PUBLIC &#34;-//W3C//DTD HTML 4.01//EN&#34;
       &#34;http://www.w3.org/TR/html4/strict.dtd&#34;&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Not Found&lt;/title
&gt;&lt;/head
&gt;&lt;body&gt;&lt;h1&gt;404 Not Found&lt;/h1
&gt;&lt;div&gt;method: POST&lt;/div
&gt;&lt;div&gt;params: ((bar baz))&lt;/div
&gt;&lt;div&gt;args: (/var/www/example.scm hoge)&lt;/div
&gt;&lt;/body
&gt;&lt;/html
&gt;</pre>

{% endraw %}
