---
layout: post
title: Gaucheでクラスのフィールド名を変数に束縛する。
tags:
- Gauche

---
{% raw %}
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Haskell">Haskell</a>でいうNamedFieldPunsのようなものです。<br />
クラスの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%BF%A5%F3%A5%B9">インスタンス</a>と、スロット名のリストを渡すことによって、スロット名と同名の変数にスロットの値を束縛するマクロを書きました。</p><p>使用例は記事の下の方にあります。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synComment">;; macro let-slots (((slot-name ...) expr) ...) body ...</span>
<span class="synComment">;; インスタンスexprのスロットslot-nameを同名の変数に束縛し、bodyを評価する。</span>
<span class="synSpecial">(</span>define-macro <span class="synSpecial">(</span>let-slots inits <span class="synSpecial">.</span> body<span class="synSpecial">)</span>
  <span class="synComment">;; symbol の頭に prefix を付けた新たなシンボルを返す。</span>
  <span class="synComment">;; また、 prefix が #f である場合は、単に symbol を返す</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>add-prefix prefix symbol<span class="synSpecial">)</span>
    <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">not</span> prefix<span class="synSpecial">)</span>
        symbol
        <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">symbol?</span> prefix<span class="synSpecial">)</span>
            <span class="synSpecial">(</span><span class="synIdentifier">string-&gt;symbol</span> <span class="synSpecial">(</span><span class="synIdentifier">apply</span> <span class="synIdentifier">string-append</span>
                                   <span class="synSpecial">(</span><span class="synIdentifier">map</span> <span class="synIdentifier">symbol-&gt;string</span> <span class="synSpecial">(</span><span class="synIdentifier">list</span> prefix symbol<span class="synSpecial">))))</span>
            <span class="synSpecial">(</span>errorf <span class="synConstant">&quot;prefix must be symbol: ~s&quot;</span> prefix<span class="synSpecial">))))</span>
  <span class="synComment">;; exprと、exprを束縛した新しい変数名varと、</span>
  <span class="synComment">;; (slot-name (slot-ref var 'slot-name))の式のリスト</span>
  <span class="synComment">;; の3つ組を作成する</span>
  <span class="synComment">;; prefixが指定された場合、スロット名の頭にプレフィックスを追加したものが</span>
  <span class="synComment">;; 対応するスロットを束縛する名前となる。</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>init-form-&gt;var&amp;expr&amp;slots slot-names expr :optional <span class="synSpecial">(</span>prefix <span class="synConstant">#f</span><span class="synSpecial">))</span>
    <span class="synSpecial">(</span><span class="synStatement">let*</span> <span class="synSpecial">((</span>var <span class="synSpecial">(</span>gensym<span class="synSpecial">))</span>
           <span class="synSpecial">(</span>init-exprs <span class="synSpecial">(</span><span class="synIdentifier">map</span> <span class="synSpecial">(</span>^<span class="synSpecial">(</span>slot-name<span class="synSpecial">)</span>
                              <span class="synSpecial">`(,(</span>add-prefix prefix slot-name<span class="synSpecial">)</span>
                                <span class="synSpecial">(</span>slot-ref <span class="synSpecial">,</span>var <span class="synSpecial">',</span>slot-name<span class="synSpecial">)))</span>
                            slot-names<span class="synSpecial">)))</span>
      <span class="synSpecial">(</span><span class="synIdentifier">values</span> expr var init-exprs<span class="synSpecial">)))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> var-name-and-init-exprs
    <span class="synSpecial">(</span><span class="synStatement">let</span> loop <span class="synSpecial">((</span>inits inits<span class="synSpecial">))</span>
      <span class="synSpecial">(</span>match inits
        <span class="synSpecial">(()</span> <span class="synSpecial">'())</span>
        <span class="synSpecial">(((</span>slot-names expr<span class="synSpecial">)</span> rest ...<span class="synSpecial">)</span>
         <span class="synSpecial">(</span>receive <span class="synSpecial">(</span>expr var init-exprs<span class="synSpecial">)</span>
             <span class="synSpecial">(</span>init-form-&gt;var&amp;expr&amp;slots slot-names expr<span class="synSpecial">)</span>
           <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">(</span><span class="synIdentifier">list</span> expr var init-exprs<span class="synSpecial">)</span>
                 <span class="synSpecial">(</span>loop rest<span class="synSpecial">))))</span>

        <span class="synSpecial">(((</span>slot-names expr :prefix prefix<span class="synSpecial">)</span> rest ...<span class="synSpecial">)</span>
         <span class="synSpecial">(</span>receive <span class="synSpecial">(</span>expr var init-exprs<span class="synSpecial">)</span>
             <span class="synSpecial">(</span>init-form-&gt;var&amp;expr&amp;slots slot-names expr prefix<span class="synSpecial">)</span>
           <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">(</span><span class="synIdentifier">list</span> expr var init-exprs<span class="synSpecial">)</span>
                 <span class="synSpecial">(</span>loop rest<span class="synSpecial">))))</span>

        <span class="synSpecial">(</span>_ <span class="synSpecial">(</span>errorf <span class="synConstant">&quot;malformed let-slots: ~s&quot;</span> inits<span class="synSpecial">)))))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> expr-inits
    <span class="synSpecial">(</span><span class="synIdentifier">map</span> <span class="synSpecial">(</span>match-lambda
           <span class="synSpecial">((</span>expr var _<span class="synSpecial">)</span> <span class="synSpecial">`(,</span>var <span class="synSpecial">,</span>expr<span class="synSpecial">)))</span>
         var-name-and-init-exprs<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> slot-inits
    <span class="synSpecial">(</span><span class="synIdentifier">apply</span> <span class="synIdentifier">append</span>
           <span class="synSpecial">(</span><span class="synIdentifier">map</span> <span class="synSpecial">(</span>match-lambda
                  <span class="synSpecial">((</span>_ _ init-exprs<span class="synSpecial">)</span> init-exprs<span class="synSpecial">))</span>
                var-name-and-init-exprs<span class="synSpecial">)))</span>
  <span class="synSpecial">`(</span>let <span class="synSpecial">,</span>expr-inits
     <span class="synSpecial">(</span>let <span class="synSpecial">,</span>slot-inits
       <span class="synSpecial">,@</span>body<span class="synSpecial">)))</span>
</pre><p>使用例:</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span>define-class <span class="synConstant">&lt;person&gt;</span> <span class="synSpecial">()</span>
  <span class="synSpecial">((</span>name :init-keyword :name<span class="synSpecial">)</span>
   <span class="synSpecial">(</span>age :init-keyword :age<span class="synSpecial">)</span>
   <span class="synSpecial">(</span>pref :init-keyword :pref<span class="synSpecial">)))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> taro <span class="synSpecial">(</span>make <span class="synConstant">&lt;person&gt;</span> :name <span class="synConstant">&quot;Taro&quot;</span> :age <span class="synConstant">20</span> :pref <span class="synConstant">&quot;Tokyo&quot;</span><span class="synSpecial">))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> jiro <span class="synSpecial">(</span>make <span class="synConstant">&lt;person&gt;</span> :name <span class="synConstant">&quot;Jiro&quot;</span> :age <span class="synConstant">15</span> :pref <span class="synConstant">&quot;Kyoto&quot;</span><span class="synSpecial">))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>print-person person<span class="synSpecial">)</span>
  <span class="synComment">;; name が (slot-ref person 'name) に束縛される。age, pref も同様</span>
  <span class="synSpecial">(</span>let-slots <span class="synSpecial">(((</span>name age pref<span class="synSpecial">)</span> person<span class="synSpecial">))</span>
    <span class="synSpecial">(</span>format <span class="synConstant">#t</span> <span class="synConstant">&quot;Name: ~a, Age: ~s, Pref.: ~a&quot;</span> name age pref<span class="synSpecial">)))</span>

<span class="synSpecial">(</span>print-person taro<span class="synSpecial">)</span>
<span class="synComment">;; =&gt; Name: Taro, Age: 20, Pref.: Tokyo</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>person-eq? me you<span class="synSpecial">)</span>
  <span class="synComment">;; :prefix で束縛される変数名のプレフィックスを指定できる</span>
  <span class="synSpecial">(</span>let-slots <span class="synSpecial">(((</span>name age pref<span class="synSpecial">)</span> me :prefix my-<span class="synSpecial">)</span>
              <span class="synSpecial">((</span>name age pref<span class="synSpecial">)</span> you :prefix your-<span class="synSpecial">))</span>
    <span class="synSpecial">(</span><span class="synStatement">and</span> <span class="synSpecial">(</span><span class="synIdentifier">string=?</span> my-name your-name<span class="synSpecial">)</span>
         <span class="synSpecial">(</span><span class="synIdentifier">=</span> my-age your-age<span class="synSpecial">)</span>
         <span class="synSpecial">(</span><span class="synIdentifier">string=?</span> my-pref your-pref<span class="synSpecial">))))</span>

<span class="synSpecial">(</span>person-eq? taro jiro<span class="synSpecial">)</span>
<span class="synComment">;; =&gt; #f</span>

<span class="synSpecial">(</span>person-eq? taro taro<span class="synSpecial">)</span>
<span class="synComment">;; =&gt; #t</span>
</pre><p>こういったマクロはer-macroがあればもう少し健全に書くことができるのですが、うちの<a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>は未だ0.9.4なので、アップデートし次第er-macroを使って書き換えてみたいと思います。</p>


{% endraw %}
