---
layout: post
title: Scheme始めました
tags:
- Gauche

---
{% raw %}
<p>某友人の影響で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Lisp">Lisp</a>に目覚めてしまったので、とりあえず<a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>の勉強を始めることにしました。<br />
(とは言っても授業で<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%F3%A5%D1%A5%A4%A5%E9">コンパイラ</a>作ったりCPU作ったりしてて結構忙しいので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>自体の勉強はかなりゆっくりになると思いますが)</p><p>なぜ数ある<a class="keyword" href="http://d.hatena.ne.jp/keyword/Lisp">Lisp</a>方言や<a class="keyword" href="http://d.hatena.ne.jp/keyword/Scheme">Scheme</a>方言の中から<a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>を選んだかと言うと、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Lisp">Lisp</a>方言の中では比較的モ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C0%A5%F3">ダン</a>な設計の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Scheme">Scheme</a>の中でも、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>が一番<a class="keyword" href="http://d.hatena.ne.jp/keyword/Common%20Lisp">Common Lisp</a>的な黒魔術的処理も書きやすそうだったからです。(他の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Lisp">Lisp</a>方言は全くと言っていいほど触ったことがないので、間違ってたらごめんなさい)</p><br />
<p>とりあえず手始めに、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%CA%A5%C9">モナド</a>を書いてみました。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>create-monad :key return &gt;&gt;=<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synIdentifier">cons</span> return &gt;&gt;=<span class="synSpecial">))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>get-return x<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">car</span> x<span class="synSpecial">))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>get-&gt;&gt;= x<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> x<span class="synSpecial">))</span>

<span class="synSpecial">(</span>define-macro <span class="synSpecial">(</span>with-monad monad <span class="synSpecial">.</span> body<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> current-monad <span class="synSpecial">(</span>gensym<span class="synSpecial">))</span>
  <span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>create-monad-body rest-body<span class="synSpecial">)</span>
    <span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>head<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">car</span> rest-body<span class="synSpecial">))</span>
    <span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>tail<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> rest-body<span class="synSpecial">))</span>
    <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">null?</span> rest-body<span class="synSpecial">)</span>
        <span class="synSpecial">'()</span>
        <span class="synSpecial">(</span><span class="synStatement">begin</span>
          <span class="synSpecial">(</span><span class="synStatement">cond</span>
           <span class="synSpecial">((</span><span class="synStatement">and</span> <span class="synSpecial">(</span><span class="synIdentifier">list?</span> <span class="synSpecial">(</span>head<span class="synSpecial">))</span> <span class="synSpecial">(</span><span class="synIdentifier">equal?</span> <span class="synSpecial">'</span>&lt;- <span class="synSpecial">(</span><span class="synIdentifier">cadr</span> <span class="synSpecial">(</span>head<span class="synSpecial">))))</span>
            <span class="synSpecial">`(((</span>get-&gt;&gt;= <span class="synSpecial">,</span>current-monad<span class="synSpecial">)</span>
              <span class="synSpecial">,(</span><span class="synIdentifier">caddr</span> <span class="synSpecial">(</span>head<span class="synSpecial">))</span>
              <span class="synSpecial">(</span>lambda <span class="synSpecial">(,(</span><span class="synIdentifier">car</span> <span class="synSpecial">(</span>head<span class="synSpecial">)))</span> <span class="synSpecial">,@(</span>create-monad-body <span class="synSpecial">(</span>tail<span class="synSpecial">))))))</span>
           <span class="synSpecial">((</span><span class="synStatement">and</span> <span class="synSpecial">(</span><span class="synIdentifier">list?</span> <span class="synSpecial">(</span>head<span class="synSpecial">))</span> <span class="synSpecial">(</span><span class="synIdentifier">equal?</span> <span class="synSpecial">'</span>return <span class="synSpecial">(</span><span class="synIdentifier">car</span> <span class="synSpecial">(</span>head<span class="synSpecial">))))</span>
            <span class="synSpecial">(</span><span class="synIdentifier">cons</span>
             <span class="synSpecial">`((</span>get-return <span class="synSpecial">,</span>current-monad<span class="synSpecial">)</span> <span class="synSpecial">,(</span><span class="synIdentifier">cadr</span> <span class="synSpecial">(</span>head<span class="synSpecial">)))</span>
             <span class="synSpecial">(</span>create-monad-bondy <span class="synSpecial">(</span>tail<span class="synSpecial">))))</span>
           <span class="synSpecial">(</span><span class="synStatement">else</span> <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">(</span>head<span class="synSpecial">)</span> <span class="synSpecial">(</span>create-monad-body <span class="synSpecial">(</span>tail<span class="synSpecial">))))))))</span>
  <span class="synSpecial">`((</span>lambda <span class="synSpecial">()</span>
      <span class="synSpecial">(</span>define <span class="synSpecial">,</span>current-monad <span class="synSpecial">,</span>monad<span class="synSpecial">)</span>
      <span class="synSpecial">,@(</span>create-monad-body body<span class="synSpecial">))))</span>
</pre><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Haskell">Haskell</a>のdo記法(<a class="keyword" href="http://d.hatena.ne.jp/keyword/Scala">Scala</a>のforのほうが近いかも)らしき文法を<a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>に追加するマクロです。</p><p>Template <a class="keyword" href="http://d.hatena.ne.jp/keyword/Haskell">Haskell</a>やQuasi Quotesのような特殊な機能を使わなくても、簡単にプログラムの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B9%BD%CA%B8%CC%DA">構文木</a>そのものを弄ることができます。</p><p>これが<a class="keyword" href="http://d.hatena.ne.jp/keyword/Lisp">Lisp</a>最大の強みですね。ハマる人が多いのもなんとなく分かります。</p><p>上で作った<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%CA%A5%C9">モナド</a>は以下のようにして利用します。例えば<a class="keyword" href="http://d.hatena.ne.jp/keyword/Haskell">Haskell</a>で言うMaybe<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%CA%A5%C9">モナド</a>がほしい場合、とりあえず以下のように自前でMaybeを定義します。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>just x<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">'</span>just x<span class="synSpecial">))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> nothing <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">'</span>nothing <span class="synConstant">#f</span><span class="synSpecial">))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>just? x<span class="synSpecial">)</span> <span class="synSpecial">(</span>symbol=? <span class="synSpecial">'</span>just <span class="synSpecial">(</span><span class="synIdentifier">car</span> x<span class="synSpecial">)))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>nothing? x<span class="synSpecial">)</span> <span class="synSpecial">(</span>symbol=? <span class="synSpecial">'</span>nothing <span class="synSpecial">(</span><span class="synIdentifier">car</span> x<span class="synSpecial">)))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>maybe-value x<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> x<span class="synSpecial">))</span>
</pre><p>そして以下のように、Maybeの<a class="keyword" href="http://d.hatena.ne.jp/keyword/Monad">Monad</a>に対する「<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%BF%A5%F3%A5%B9">インスタンス</a>宣言」を行います</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>maybe-return x<span class="synSpecial">)</span> <span class="synSpecial">(</span>just x<span class="synSpecial">))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>maybe-&gt;&gt;= x f<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>nothing? x<span class="synSpecial">)</span>
      nothing
      <span class="synSpecial">(</span>f <span class="synSpecial">(</span>maybe-value x<span class="synSpecial">))))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> maybe-monad
  <span class="synSpecial">(</span>create-monad
   :return maybe-return
   :&gt;&gt;= maybe-&gt;&gt;=<span class="synSpecial">))</span>
</pre><p>実際に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%CA%A5%C9">モナド</a>を使用するには、上で定義したwith-<a class="keyword" href="http://d.hatena.ne.jp/keyword/monad">monad</a>構文を使用します。具体的には以下のような感じで使用します。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synComment">;; 分母が0のときはnothingを返す除算</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>safe-/ x y<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">=</span> y <span class="synConstant">0</span><span class="synSpecial">)</span>
      nothing
      <span class="synSpecial">(</span>just <span class="synSpecial">(</span><span class="synIdentifier">/</span> x y<span class="synSpecial">))))</span>

<span class="synComment">;; 使用例</span>
<span class="synComment">;; with-monadがHaskellのdo記法に相当</span>
<span class="synComment">;; &lt;-とreturnはそれぞれHaskellの&lt;-とreturnとだいたい同じ</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>div-by-y-and-z x y z<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>with-monad maybe-monad
    <span class="synSpecial">(</span>a &lt;- <span class="synSpecial">(</span>safe-/ x y<span class="synSpecial">))</span>
    <span class="synSpecial">(</span>b &lt;- <span class="synSpecial">(</span>safe-/ x z<span class="synSpecial">))</span>
    <span class="synSpecial">(</span>return <span class="synSpecial">(</span><span class="synIdentifier">+</span> a b<span class="synSpecial">))))</span>
</pre><p>実行結果は以下のようになります。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink>gosh&gt; <span class="synSpecial">(</span>div-by-y-and-z <span class="synConstant">2</span> <span class="synConstant">3</span> <span class="synConstant">4</span><span class="synSpecial">)</span>
<span class="synSpecial">(</span>just <span class="synSpecial">.</span> <span class="synConstant">7/6</span><span class="synSpecial">)</span>
gosh&gt; <span class="synSpecial">(</span>div-by-y-and-z <span class="synConstant">2</span> <span class="synConstant">0</span> <span class="synConstant">1</span><span class="synSpecial">)</span> <span class="synComment">; nothingになったところで計算が止まる</span>
<span class="synSpecial">(</span>nothing <span class="synSpecial">.</span> <span class="synConstant">#f</span><span class="synSpecial">)</span>
gosh&gt; <span class="synSpecial">(</span>div-by-y-and-z <span class="synConstant">2</span> <span class="synConstant">1</span> <span class="synConstant">0</span><span class="synSpecial">)</span>
<span class="synSpecial">(</span>nothing <span class="synSpecial">.</span> <span class="synConstant">#f</span><span class="synSpecial">)</span>
</pre><p>実際にどんな処理を行っているかというと、だいたい<a class="keyword" href="http://d.hatena.ne.jp/keyword/Haskell">Haskell</a>のdo記法と同じで</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span>x &lt;- <span class="synSpecial">(</span>monadic-action<span class="synSpecial">))</span>
...
</pre><p>の形の式を</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span>hoge-&gt;&gt;= <span class="synSpecial">(</span>monadic-action<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>x<span class="synSpecial">)</span> ...<span class="synSpecial">))</span>
</pre><p>に書き換えてるだけです。</p><br />
<p>他にも、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%B9%A5%C8%A5%E2">リストモ</a>ナドとかState<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%CA%A5%C9">モナド</a>も以下のようにして定義することができます。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synComment">;; List</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>list-return x<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">list</span> x<span class="synSpecial">))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>list-&gt;&gt;= x f<span class="synSpecial">)</span> <span class="synSpecial">(</span>concatenate <span class="synSpecial">(</span><span class="synIdentifier">map</span> f x<span class="synSpecial">)))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> list-monad
  <span class="synSpecial">(</span>create-monad
   :return list-return
   :&gt;&gt;= list-&gt;&gt;=<span class="synSpecial">))</span>

<span class="synComment">;; State</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>state-return a<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>s<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">cons</span> a s<span class="synSpecial">)))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>state-&gt;&gt;= x f<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>s<span class="synSpecial">)</span>
    <span class="synSpecial">(</span><span class="synStatement">define</span> x-result <span class="synSpecial">(</span>x s<span class="synSpecial">))</span>
    <span class="synSpecial">(</span><span class="synStatement">define</span> a2 <span class="synSpecial">(</span><span class="synIdentifier">car</span> x-result<span class="synSpecial">))</span>
    <span class="synSpecial">(</span><span class="synStatement">define</span> s2 <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> x-result<span class="synSpecial">))</span>
    <span class="synSpecial">((</span>f a2<span class="synSpecial">)</span> s2<span class="synSpecial">)))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>get<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>s<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">cons</span> s s<span class="synSpecial">)))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>put x<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>_<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">cons</span> <span class="synSpecial">'()</span> x<span class="synSpecial">)))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> state-monad
  <span class="synSpecial">(</span>create-monad
   :return state-return
   :&gt;&gt;= state-&gt;&gt;=<span class="synSpecial">))</span>

<span class="synComment">;; 使用例</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>list-example<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>with-monad list-monad
    <span class="synSpecial">(</span>a &lt;- <span class="synSpecial">(</span><span class="synIdentifier">list</span> <span class="synConstant">1</span> <span class="synConstant">2</span> <span class="synConstant">3</span><span class="synSpecial">))</span>
    <span class="synSpecial">(</span>b &lt;- <span class="synSpecial">(</span><span class="synIdentifier">list</span> <span class="synConstant">4</span> <span class="synConstant">5</span> <span class="synConstant">6</span><span class="synSpecial">))</span>
    <span class="synSpecial">(</span>return <span class="synSpecial">(</span><span class="synIdentifier">cons</span> a b<span class="synSpecial">))))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>state-example<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>with-monad state-monad
    <span class="synSpecial">(</span>state &lt;- <span class="synSpecial">(</span>get<span class="synSpecial">))</span>
    <span class="synSpecial">(</span>_ &lt;- <span class="synSpecial">(</span>put <span class="synSpecial">(</span><span class="synIdentifier">+</span> state <span class="synConstant">1</span><span class="synSpecial">)))</span>
    <span class="synSpecial">(</span>return <span class="synSpecial">(</span><span class="synIdentifier">*</span> state <span class="synConstant">2</span><span class="synSpecial">))))</span>
</pre><p>それぞれ実行結果は以下のようになります。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink>gosh&gt; <span class="synSpecial">(</span>list-example<span class="synSpecial">)</span>
<span class="synSpecial">((</span><span class="synConstant">1</span> <span class="synSpecial">.</span> <span class="synConstant">4</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synConstant">1</span> <span class="synSpecial">.</span> <span class="synConstant">5</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synConstant">1</span> <span class="synSpecial">.</span> <span class="synConstant">6</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synConstant">2</span> <span class="synSpecial">.</span> <span class="synConstant">4</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synConstant">2</span> <span class="synSpecial">.</span> <span class="synConstant">5</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synConstant">2</span> <span class="synSpecial">.</span> <span class="synConstant">6</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synConstant">3</span> <span class="synSpecial">.</span> <span class="synConstant">4</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synConstant">3</span> <span class="synSpecial">.</span> <span class="synConstant">5</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synConstant">3</span> <span class="synSpecial">.</span> <span class="synConstant">6</span><span class="synSpecial">))</span>
gosh&gt; <span class="synSpecial">((</span>state-example<span class="synSpecial">)</span> <span class="synConstant">5</span><span class="synSpecial">)</span>
<span class="synSpecial">(</span><span class="synConstant">10</span> <span class="synSpecial">.</span> <span class="synConstant">6</span><span class="synSpecial">)</span> <span class="synComment">; result =&gt; (* 5 2), state =&gt; (+ 5 1)</span>
</pre><p>ちなみに<a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>歴というか<a class="keyword" href="http://d.hatena.ne.jp/keyword/Lisp">Lisp</a>歴自体触り始めてから12時間も経ってないので、もっといい書き方とかある場合は教えてください。</p><p>あと、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Lisp">Lisp</a>の場合は継続使ったほうが綺麗に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%CA%A5%C9">モナド</a>書けそうな気もするんで、気が向いたらやってみたいです。</p>


{% endraw %}
