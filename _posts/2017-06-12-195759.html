---
layout: post
title: Gaucheでセッターを定義する
tags:
- Gauche

---
{% raw %}
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>ではデータ構造の特定の値を変更するのに、</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synSpecial">(</span>~ <span class="synIdentifier">vector</span> i<span class="synSpecial">)</span> <span class="synConstant">10</span><span class="synSpecial">)</span>
</pre><p>とか</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synSpecial">(</span><span class="synIdentifier">cdr</span> pair<span class="synSpecial">)</span> <span class="synSpecial">())</span>
</pre><p>とかできてしまうのが不思議だったので、方法を調べてみました。</p><p>まずは例として、以下のようなクラスを作ってみます。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span>define-class <span class="synConstant">&lt;temperature&gt;</span> <span class="synSpecial">()</span>
  <span class="synSpecial">([</span>celsius :init-keyword :celsius<span class="synSpecial">]))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>celsius-&gt;temperature c<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>make <span class="synConstant">&lt;temperature&gt;</span> :celsius c<span class="synSpecial">))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>fahrenheit-&gt;temperature k<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>make <span class="synConstant">&lt;temperature&gt;</span> :celsius <span class="synSpecial">(</span>k-&gt;c k<span class="synSpecial">)))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>celsius temp<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>~ temp <span class="synSpecial">'</span>celsius<span class="synSpecial">))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>fahrenheit temp<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>c-&gt;k <span class="synSpecial">(</span>~ temp <span class="synSpecial">'</span>celsius<span class="synSpecial">)))</span>



<span class="synComment">;; helper functions</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>k-&gt;c k<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synIdentifier">*</span> <span class="synConstant">5/9</span> <span class="synSpecial">(</span><span class="synIdentifier">-</span> k <span class="synConstant">32</span><span class="synSpecial">)))</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>c-&gt;k c<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synIdentifier">+</span> <span class="synConstant">32</span> <span class="synSpecial">(</span><span class="synIdentifier">*</span> <span class="synConstant">9/5</span> c<span class="synSpecial">)))</span>
</pre><p>これは単位に関係なく温度を扱うことのできるクラスです。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> t <span class="synSpecial">(</span>celsius-&gt;temperature <span class="synConstant">32</span><span class="synSpecial">))</span>
<span class="synSpecial">(</span>fahrenheit t<span class="synSpecial">)</span> <span class="synComment">; =&gt; 448/5</span>

<span class="synSpecial">(</span><span class="synStatement">define</span> t1 <span class="synSpecial">(</span>fahrenheit-&gt;temperature <span class="synConstant">50</span><span class="synSpecial">))</span>
<span class="synSpecial">(</span>celsius t1<span class="synSpecial">)</span> <span class="synComment">; =&gt; 10</span>
</pre><p>このクラスにセッターを定義してみましょう。まずは原型から。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>set-celsius! temp c<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synSpecial">(</span>~ temp <span class="synSpecial">'</span>celsius<span class="synSpecial">)</span> c<span class="synSpecial">))</span>
<span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>set-fahrenheit! temp k<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synSpecial">(</span>~ temp <span class="synSpecial">'</span>celsius<span class="synSpecial">)</span> <span class="synSpecial">(</span>k-&gt;c k<span class="synSpecial">)))</span>
</pre><p>これでも充分ですが、どうせなら組み込み型と同じように</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synSpecial">(</span>celsius temp<span class="synSpecial">)</span> <span class="synConstant">10</span><span class="synSpecial">)</span>
</pre><p>のようにできたらかっこいいですよね。</p><p>これを行うためのメソッドがsetterです。</p><p><a href="https://practical-scheme.net/gauche/man/gauche-refj/Dai-Ru-.html">https://practical-scheme.net/gauche/man/gauche-refj/Dai-Ru-.html</a></p><p>リファレンスだと少々わかりにくいような気がするのですが、setterメソッドを定義してやればset!等で使えるようになるようです。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span>define-method <span class="synSpecial">(</span>setter celsius<span class="synSpecial">)</span> <span class="synSpecial">((</span>t <span class="synConstant">&lt;temperature&gt;</span><span class="synSpecial">)</span> c<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>set-celsius! t c<span class="synSpecial">))</span>
<span class="synSpecial">(</span>define-method <span class="synSpecial">(</span>setter fahrenheit<span class="synSpecial">)</span> <span class="synSpecial">((</span>t <span class="synConstant">&lt;temperature&gt;</span><span class="synSpecial">)</span> k<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>set-fahrenheit! t k<span class="synSpecial">))</span>

<span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synSpecial">(</span>celsius t<span class="synSpecial">)</span> <span class="synConstant">10</span><span class="synSpecial">)</span>
<span class="synSpecial">(</span>fahrenheit t<span class="synSpecial">)</span> <span class="synComment">; =&gt; 50</span>
<span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synSpecial">(</span>fahrenheit t<span class="synSpecial">)</span> <span class="synConstant">32</span><span class="synSpecial">)</span>
<span class="synSpecial">(</span>celsius t<span class="synSpecial">)</span> <span class="synComment">; =&gt; 0</span>
</pre><p>ちなみに、</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span>define-method <span class="synSpecial">(</span>setter celsius<span class="synSpecial">)</span> <span class="synSpecial">(</span>...<span class="synSpecial">)</span> ...<span class="synSpecial">)</span>
</pre><p>は特にsetter用の特殊構文などではなく、一般に</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">((</span>f x<span class="synSpecial">)</span> y z ...<span class="synSpecial">)</span> ...<span class="synSpecial">)</span>
</pre><p>のような書き方は</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>f x<span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>y z ...<span class="synSpecial">)</span> ...<span class="synSpecial">))</span>
</pre><p>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%F3%A5%BF%A5%C3%A5%AF%A5%B9">シンタックス</a>シュガーとなっています。</p><p>また、総称関数refとそのsetterを定義すると、万能アクセサ~を使った</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">set!</span> <span class="synSpecial">(</span>~ hoge x<span class="synSpecial">)</span> y<span class="synSpecial">)</span>
</pre><p>というような記法が使えるようになります。</p>


{% endraw %}
