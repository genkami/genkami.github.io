---
layout: post
title: Gaucheで文字列のシーケンシャルアクセス
tags:
- Gauche

---
{% raw %}
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>でそこそこサイズの大きい文字列へのシーケンシャルアクセスをしたい場合の注意点です。</p><p>例として、以下のURLにある『<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B8%E3%C7%DA%A4%CF%C7%AD%A4%C7%A4%A2%A4%EB">吾輩は猫である</a>』の文書中に、何回「猫」という文字が出てくるかを調べてみましょう。</p><p><a href="http://www.aozora.gr.jp/cards/000148/card789.html#download">http://www.aozora.gr.jp/cards/000148/card789.html#download</a><br />
</p>
<pre class="code" data-lang="" data-unlink>$ wget http://www.aozora.gr.jp/cards/000148/files/789_ruby_5639.zip
$ unzip 789_ruby_5639.zip 
$ nkf -w wagahaiwa_nekodearu.txt &gt; neko_utf8.txt
$ ls -lh neko_utf8.txt 
-rw-rw-r-- 1 cloudear8 cloudear8 1.1M 11月 13 22:26 neko_utf8.txt</pre><p>このneko_utf8.txtを<a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>から読み込んでみます。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> book <span class="synSpecial">(</span><span class="synIdentifier">call-with-input-file</span> <span class="synConstant">&quot;/path/to/neko_utf8.txt&quot;</span>
               port-&gt;string<span class="synSpecial">))</span>

<span class="synSpecial">(</span><span class="synIdentifier">string-length</span> book<span class="synSpecial">)</span> <span class="synComment">; =&gt; 377272</span>
</pre><p>この37万7272文字の文書から、「猫」という文字の数をカウントしてみましょう。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>count-neko1 book<span class="synSpecial">)</span>
  <span class="synSpecial">(</span><span class="synStatement">let</span> loop <span class="synSpecial">((</span>count <span class="synConstant">0</span><span class="synSpecial">)</span>
             <span class="synSpecial">(</span>i <span class="synConstant">0</span><span class="synSpecial">))</span>
    <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">&lt;=</span> <span class="synSpecial">(</span><span class="synIdentifier">string-length</span> book<span class="synSpecial">)</span> i<span class="synSpecial">)</span>
        count
        <span class="synSpecial">(</span><span class="synStatement">let</span> <span class="synSpecial">((</span>c <span class="synSpecial">(</span><span class="synIdentifier">string-ref</span> book i<span class="synSpecial">)))</span>
          <span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">char=?</span> c <span class="synConstant">#\猫</span><span class="synSpecial">)</span>
              <span class="synSpecial">(</span>loop <span class="synSpecial">(</span><span class="synIdentifier">+</span> count <span class="synConstant">1</span><span class="synSpecial">)</span> <span class="synSpecial">(</span><span class="synIdentifier">+</span> i <span class="synConstant">1</span><span class="synSpecial">))</span>
              <span class="synSpecial">(</span>loop count <span class="synSpecial">(</span><span class="synIdentifier">+</span> i <span class="synConstant">1</span><span class="synSpecial">)))))))</span>

<span class="synSpecial">(</span>count-neko1 book<span class="synSpecial">)</span> <span class="synComment">; =&gt; 終わらない</span>
</pre><p>たかだか377272回のループのはずが、この関数は非常に実行に時間がかかってしまいます。<br />
では、この関数の実行時間のオーダーはどれくらいになっているのでしょうか。bookの部分文字列に対してcount-neko1を呼んでみましょう。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span>time <span class="synSpecial">(</span>count-neko1 <span class="synSpecial">(</span><span class="synIdentifier">substring</span> book <span class="synConstant">0</span> <span class="synConstant">1000</span><span class="synSpecial">)))</span>
<span class="synComment">;;(time (count-neko1 (substring book 0 1000)))</span>
<span class="synComment">;; real   0.003</span>
<span class="synComment">;; user   0.010</span>
<span class="synComment">;; sys    0.000</span>

<span class="synSpecial">(</span>time <span class="synSpecial">(</span>count-neko1 <span class="synSpecial">(</span><span class="synIdentifier">substring</span> book <span class="synConstant">0</span> <span class="synConstant">2000</span><span class="synSpecial">)))</span>
<span class="synComment">;;(time (count-neko1 (substring book 0 2000)))</span>
<span class="synComment">;; real   0.011</span>
<span class="synComment">;; user   0.020</span>
<span class="synComment">;; sys    0.000</span>

<span class="synSpecial">(</span>time <span class="synSpecial">(</span>count-neko1 <span class="synSpecial">(</span><span class="synIdentifier">substring</span> book <span class="synConstant">0</span> <span class="synConstant">4000</span><span class="synSpecial">)))</span>
<span class="synComment">;;(time (count-neko1 (substring book 0 4000)))</span>
<span class="synComment">;; real   0.044</span>
<span class="synComment">;; user   0.050</span>
<span class="synComment">;; sys    0.000</span>

<span class="synSpecial">(</span>time <span class="synSpecial">(</span>count-neko1 <span class="synSpecial">(</span><span class="synIdentifier">substring</span> book <span class="synConstant">0</span> <span class="synConstant">16000</span><span class="synSpecial">)))</span>
<span class="synComment">;;(time (count-neko1 (substring book 0 16000)))</span>
<span class="synComment">;; real   0.670</span>
<span class="synComment">;; user   0.660</span>
<span class="synComment">;; sys    0.000</span>
</pre><p>ざっと概算して、だいたいn^2くらいのオーダーになっていることがわかるでしょうか。<br />
実はこれは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>の文字列の仕様によるものが原因です。</p><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Gauche">Gauche</a>の文字列は文字の配列ではなく、ただの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4">バイ</a>ト列を動的に解析して文字として扱っています。<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a>等の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%B8%BB%FA%A5%B3%A1%BC%A5%C9">文字コード</a>では1文字の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4">バイ</a>ト数が一定ではないため、(string-ref book i)が呼ばれるたびにbookを頭から読み込み、どこからどこまでが1文字なのかを順番に調べ、i番目の文字にたどり着いたところでその値を返しているのです。</p><p>実際に、string-refの実行時間を計測することで、おおよそのオーダーを測ってみましょう。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span>use gauche.time<span class="synSpecial">)</span>
<span class="synSpecial">(</span>time-this <span class="synConstant">10000</span> <span class="synSpecial">(</span>^<span class="synSpecial">()</span> <span class="synSpecial">(</span><span class="synIdentifier">string-ref</span> book <span class="synConstant">10</span><span class="synSpecial">)))</span>
<span class="synComment">;; =&gt; #&lt;time-result 10000 times/  0.003 real/  0.010 user/  0.000 sys&gt;</span>
<span class="synSpecial">(</span>time-this <span class="synConstant">10000</span> <span class="synSpecial">(</span>^<span class="synSpecial">()</span> <span class="synSpecial">(</span><span class="synIdentifier">string-ref</span> book <span class="synConstant">100</span><span class="synSpecial">)))</span>
<span class="synComment">;; =&gt; #&lt;time-result 10000 times/  0.006 real/  0.010 user/  0.000 sys&gt;</span>
<span class="synSpecial">(</span>time-this <span class="synConstant">10000</span> <span class="synSpecial">(</span>^<span class="synSpecial">()</span> <span class="synSpecial">(</span><span class="synIdentifier">string-ref</span> book <span class="synConstant">1000</span><span class="synSpecial">)))</span>
<span class="synComment">;; =&gt; #&lt;time-result 10000 times/  0.051 real/  0.050 user/  0.000 sys&gt;</span>
<span class="synSpecial">(</span>time-this <span class="synConstant">10000</span> <span class="synSpecial">(</span>^<span class="synSpecial">()</span> <span class="synSpecial">(</span><span class="synIdentifier">string-ref</span> book <span class="synConstant">10000</span><span class="synSpecial">)))</span>
<span class="synComment">;; =&gt; #&lt;time-result 10000 times/  0.530 real/  0.520 user/  0.000 sys&gt;</span>
</pre><p>大体nくらいのオーダーであることがわかります。</p><br />
<br />
<p>では、文字列の先頭から順に定数時間でアクセスするためにはどうすればよいでしょうか？</p><br />
<p>答えは、文字列ポートを使用する方法です。<br />
文字列ポートは現在の読み込み位置を内部に持っているので、定数時間で次の文字にアクセスすることができます。</p><p>文字列ポートを使ってcount-neko1を書き換えてみましょう。</p>
<pre class="code lang-scheme" data-lang="scheme" data-unlink><span class="synSpecial">(</span><span class="synStatement">define</span> <span class="synSpecial">(</span>count-neko2 book<span class="synSpecial">)</span>
  <span class="synSpecial">(</span>with-input-from-string book
    <span class="synSpecial">(</span>^<span class="synSpecial">()</span>
      <span class="synSpecial">(</span><span class="synStatement">let</span> loop <span class="synSpecial">((</span>count <span class="synConstant">0</span><span class="synSpecial">))</span>
        <span class="synSpecial">(</span><span class="synStatement">define</span> c <span class="synSpecial">(</span><span class="synIdentifier">read-char</span><span class="synSpecial">))</span>
        <span class="synSpecial">(</span><span class="synStatement">cond</span>
         <span class="synSpecial">((</span><span class="synIdentifier">eof-object?</span> c<span class="synSpecial">)</span> count<span class="synSpecial">)</span>
         <span class="synSpecial">((</span><span class="synIdentifier">char=?</span> c <span class="synConstant">#\猫</span><span class="synSpecial">)</span> <span class="synSpecial">(</span>loop <span class="synSpecial">(</span><span class="synIdentifier">+</span> count <span class="synConstant">1</span><span class="synSpecial">)))</span>
         <span class="synSpecial">(</span><span class="synStatement">else</span> <span class="synSpecial">(</span>loop count<span class="synSpecial">)))))))</span>

<span class="synSpecial">(</span>count-neko2 book<span class="synSpecial">)</span> <span class="synComment">; =&gt; 263</span>

<span class="synSpecial">(</span>time <span class="synSpecial">(</span>count-neko2 book<span class="synSpecial">))</span>
<span class="synComment">;;(time (count-neko2 book))</span>
<span class="synComment">;; real   0.082</span>
<span class="synComment">;; user   0.110</span>
<span class="synComment">;; sys    0.010</span>
</pre><p>今度は現実的な時間で実行を終えることができました。</p>


{% endraw %}
